<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>MedCityAI - Article</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<meta property="og:site_name" content="MedCityAI" />
		<meta property="og:type" content="article" />
		<link rel="me" href="https://www.linkedin.com/company/medcityai/" />
		<meta property="article:publisher" content="https://www.linkedin.com/company/medcityai/" />
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		
		<link rel="stylesheet" href="assets/css/main.css" media="print" onload="this.media='all'">
		<link rel="stylesheet" href="assets/css/navigation.css" media="print" onload="this.media='all'">
		<noscript>
			<link rel="stylesheet" href="assets/css/main.css">
			<link rel="stylesheet" href="assets/css/navigation.css">
		</noscript>
		
		<link rel="stylesheet" href="assets/css/fontawesome-all.min.css" media="print" onload="this.media='all'">
		<noscript><link rel="stylesheet" href="assets/css/fontawesome-all.min.css"></noscript>
		
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		
		<style>
			/* Critical styles */
			body {
				margin: 0;
				padding: 0;
				font-family: system-ui, -apple-system, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
				background: #f5f7fa;
			}
			#page-wrapper { width: 100%; }
			.top-bar {
				background: #fff;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
				position: fixed;
				top: 0;
				width: 100%;
				z-index: 1000;
			}

			/* Article Page Styles */
			.article-hero {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 80px 20px 60px;
				margin-top: 50px;
				text-align: center;
				position: relative;
				overflow: hidden;
			}

			.article-hero::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120"><path d="M0,50 Q300,0 600,50 T1200,50 L1200,120 L0,120 Z" fill="rgba(255,255,255,0.1)"/></svg>') repeat-x;
				background-size: 600px 120px;
				opacity: 0.3;
			}

			.article-hero-content {
				position: relative;
				z-index: 1;
				max-width: 900px;
				margin: 0 auto;
			}

			.article-title {
				font-size: 2.8em;
				font-weight: 700;
				line-height: 1.2;
				margin: 0 0 30px 0;
				text-shadow: 0 2px 8px rgba(0,0,0,0.2);
			}

			.article-metadata-bar {
				display: flex;
				justify-content: center;
				gap: 25px;
				flex-wrap: wrap;
				margin: 30px 0;
				font-size: 0.95em;
			}

			.metadata-item {
				display: flex;
				align-items: center;
				gap: 8px;
				background: rgba(255,255,255,0.15);
				padding: 10px 15px;
				border-radius: 20px;
				backdrop-filter: blur(10px);
			}

			.metadata-item i {
				opacity: 0.9;
			}

			/* Main content area */
			.article-container {
				max-width: 900px;
				margin: -40px auto 0;
				padding: 0 20px 40px;
				position: relative;
				z-index: 10;
			}

			.article-main-card {
				background: white;
				border-radius: 12px;
				box-shadow: 0 10px 40px rgba(0,0,0,0.1);
				padding: 40px;
				margin-bottom: 30px;
			}

			.section-title {
				font-size: 1.4em;
				font-weight: 700;
				color: #2c3e50;
				margin: 30px 0 20px 0;
				padding-bottom: 15px;
				border-bottom: 3px solid #667eea;
				display: inline-block;
			}

			.authors-section {
				margin: 30px 0;
			}

			.authors-list {
				display: flex;
				flex-wrap: wrap;
				gap: 12px;
				margin-top: 15px;
			}

			.author-tag {
				background: #f0f2f5;
				padding: 8px 14px;
				border-radius: 20px;
				font-size: 0.9em;
				cursor: pointer;
				transition: all 0.3s ease;
			}

			.author-tag:hover {
				background: #667eea;
				color: white;
				transform: translateY(-2px);
			}

			.author-tag.rochester {
				background: #e8f4f8;
				border-left: 3px solid #00796b;
				font-weight: 600;
				color: #00796b;
			}

			.author-tag.rochester:hover {
				background: #00796b;
				color: white;
			}

			/* Abstract section */
			.abstract-section {
				background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
				padding: 25px;
				border-radius: 10px;
				border-left: 4px solid #667eea;
				margin: 30px 0;
				line-height: 1.8;
				color: #495057;
			}

			/* AI Summary */
			.ai-summary-section {
				background: linear-gradient(135deg, #fff9e6 0%, #fff3cc 100%);
				padding: 25px;
				border-radius: 10px;
				border-left: 4px solid #ffc107;
				margin: 30px 0;
			}

			.ai-summary-header {
				display: flex;
				align-items: center;
				gap: 10px;
				margin-bottom: 15px;
			}

			.ai-summary-header h3 {
				margin: 0;
				color: #f57f17;
				font-size: 1.2em;
			}

			.ai-badge {
				background: #ffc107;
				color: #000;
				padding: 4px 10px;
				border-radius: 12px;
				font-size: 0.75em;
				font-weight: 700;
			}

			.ai-summary-content {
				color: #333;
				line-height: 1.8;
				margin-bottom: 15px;
			}

			.ai-disclaimer {
				background: white;
				padding: 15px;
				border-radius: 8px;
				border-left: 3px solid #ffc107;
				font-size: 0.9em;
				color: #666;
				line-height: 1.6;
				margin-top: 15px;
			}

			.ai-disclaimer strong {
				color: #f57f17;
			}

			/* Specialties */
			.specialties-section {
				margin: 25px 0;
			}

			.specialty-badges {
				display: flex;
				flex-wrap: wrap;
				gap: 10px;
				margin-top: 12px;
			}

			.specialty-badge {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				padding: 10px 16px;
				border-radius: 20px;
				font-size: 0.9em;
				font-weight: 600;
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}

			/* Citation info */
			.citation-info {
				background: #f8f9fa;
				padding: 20px;
				border-radius: 10px;
				margin: 25px 0;
				font-size: 0.95em;
				color: #495057;
				line-height: 1.8;
				border-left: 4px solid #6c757d;
			}

			.citation-info strong {
				color: #2c3e50;
			}

			/* Action buttons */
			.action-buttons {
				display: flex;
				gap: 15px;
				justify-content: center;
				flex-wrap: wrap;
				margin: 35px 0;
			}

			.btn {
				padding: 12px 24px;
				border: none;
				border-radius: 8px;
				font-size: 1em;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
				gap: 8px;
				text-decoration: none;
			}

			.btn-primary {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
			}

			.btn-primary:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
			}

			.btn-secondary {
				background: #f0f2f5;
				color: #2c3e50;
				border: 2px solid #667eea;
			}

			.btn-secondary:hover {
				background: #667eea;
				color: white;
			}

			.btn-linkedin {
				background: #0a66c2;
				color: white;
			}

			.btn-linkedin:hover {
				background: #084394;
			}

			/* Error state */
			.error-state {
				background: white;
				border-radius: 12px;
				padding: 60px 20px;
				text-align: center;
				margin: 40px auto;
				max-width: 600px;
			}

			.error-state i {
				font-size: 4em;
				color: #e74c3c;
				margin-bottom: 20px;
			}

			.error-state h2 {
				color: #2c3e50;
				margin: 20px 0;
			}

			.error-state p {
				color: #7f8c8d;
				line-height: 1.6;
				margin: 15px 0;
			}

			/* Loading state */
			.loading-spinner {
				display: flex;
				justify-content: center;
				align-items: center;
				min-height: 500px;
			}

			.spinner {
				border: 4px solid #f0f2f5;
				border-top: 4px solid #667eea;
				border-radius: 50%;
				width: 50px;
				height: 50px;
				animation: spin 1s linear infinite;
			}

			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}

			/* Responsive */
			@media (max-width: 768px) {
				.article-title {
					font-size: 1.8em;
				}

				.article-metadata-bar {
					gap: 12px;
				}

				.metadata-item {
					font-size: 0.85em;
					padding: 8px 12px;
				}

				.article-main-card {
					padding: 25px;
				}

				.action-buttons {
					flex-direction: column;
				}

				.btn {
					width: 100%;
					justify-content: center;
				}
			}

			/* Footer integration */
			#footer {
				margin-top: 60px;
				border-top: 1px solid #e0e0e0;
			}
		</style>
	</head>
	<body class="is-preload">
		<!-- Page Wrapper -->
		<div id="page-wrapper">
			<!-- Navigation -->
			<nav class="top-bar">
				<a href="index.html" style="display: inline-block; padding: 12px 20px; font-weight: 600; color: #667eea; text-decoration: none; font-size: 1.2em;">
					<i class="fas fa-arrow-left"></i> Back to Feed
				</a>
			</nav>

			<!-- Article Container -->
			<div id="articleContent">
				<div class="loading-spinner">
					<div class="spinner"></div>
				</div>
			</div>
		</div>

		<!-- Footer -->
		<footer id="footer" style="padding: 40px 20px; text-align: center; color: #7f8c8d; background: #f8f9fa;">
			<p>&copy; 2026 MedCityAI. <a href="index.html" style="color: #667eea; text-decoration: none;">Return to Research Feed</a></p>
		</footer>

		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/main.js"></script>

		<script>
			// Parse URL parameters
			function getUrlParameter(name) {
				const url = new URL(window.location);
				return url.searchParams.get(name);
			}

			// CSV parsing function
			function parseCSVLine(line) {
				const result = [];
				let current = '';
				let inQuotes = false;
				let i = 0;
				
				while (i < line.length) {
					const char = line[i];
					
					if (char === '"') {
						if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
							current += '"';
							i += 2;
							continue;
						}
						inQuotes = !inQuotes;
					} else if (char === ',' && !inQuotes) {
						result.push(current.replace(/^"|"$/g, '').trim());
						current = '';
					} else {
						current += char;
					}
					i++;
				}
				result.push(current.replace(/^"|"$/g, '').trim());
				return result;
			}

			// Load and display article
			async function loadArticle() {
				const pmid = getUrlParameter('id');
				console.log('Loading article with PMID:', pmid);
				
				if (!pmid) {
					showError('No article ID provided', 'Please specify a PMID using ?id=PMID', 'question-circle');
					return;
				}

				try {
					console.log('Fetching CSV...');
					const response = await fetch('pubmed_data.csv');
					if (!response.ok) throw new Error('CSV file not found');
					
					const csvText = await response.text();
					console.log('CSV loaded, size:', csvText.length, 'bytes');
					
					const lines = csvText.split('\n');
					console.log('Total lines:', lines.length);
					
					const headers = parseCSVLine(lines[0]);
					console.log('Headers:', headers.length, headers);
					
					// Find the article with matching PMID
					let article = null;
					for (let i = 1; i < lines.length; i++) {
						if (!lines[i].trim()) continue;
						
						const row = parseCSVLine(lines[i]);
						if (row.length === headers.length) {
							const data = {};
							headers.forEach((header, index) => {
								data[header] = row[index];
							});
							
							if (data.pmid && data.pmid.trim() === pmid.trim()) {
								console.log('Found article:', data.title);
								article = data;
								break;
							}
						}
					}
					
					if (!article) {
						console.log('Article not found for PMID:', pmid);
						showError('Article not found', `No article found with PMID: ${pmid}`, 'search');
						return;
					}

					displayArticle(article);
					updateMetaTags(article);
					
				} catch (error) {
					console.error('Error loading article:', error);
					showError('Error loading article', error.message, 'exclamation-triangle');
				}
			}

			// Display article
			function displayArticle(article) {
				const container = document.getElementById('articleContent');
				
				// Parse fields
				const title = article.title || 'Untitled';
				const authors = article.authors_display ? article.authors_display.split('|').map(a => a.trim()) : [];
				const rochesterAuthors = article.rochester_authors ? article.rochester_authors.split('|').map(a => a.trim()) : [];
				const journal = article.journal || 'Unknown Journal';
				const pubdate = article.pubdate || 'Unknown Date';
				const year = article.year || '';
				const abstract = article.abstract || '';
				const llmSummary = article.llm_summary || '';
				const url = article.url || `https://pubmed.ncbi.nlm.nih.gov/${article.pmid}/`;
				const primarySpecialty = article.primary_specialty || '';
				const secondarySpecialty = article.secondary_specialty || '';
				const pmid = article.pmid || '';

				// Build specialty badges
				let specialtyHtml = '';
				if (primarySpecialty) {
					specialtyHtml += `<div class="specialty-badge">${primarySpecialty}</div>`;
				}
				if (secondarySpecialty && secondarySpecialty !== primarySpecialty) {
					specialtyHtml += `<div class="specialty-badge">${secondarySpecialty}</div>`;
				}

				// Build authors list
				let authorsHtml = '';
				authors.forEach(author => {
					const isRochester = rochesterAuthors.includes(author);
					const className = isRochester ? 'author-tag rochester' : 'author-tag';
					authorsHtml += `<div class="${className}" title="${isRochester ? 'Rochester Author' : 'Author'}">${author}${isRochester ? ' â˜…' : ''}</div>`;
				});

				// Create Open Graph compatible URL with UTM
				const pubmedUrlWithUtm = `${url}${url.includes('?') ? '&' : '?'}utm_source=linkedin&utm_medium=share&utm_campaign=medcityai_share`;

				// LinkedIn share text
				const lastTwoSentences = getLastTwoSentences(llmSummary);
				const linkedinShareText = `New research worth noting:\n\n${lastTwoSentences}\n\n${pubmedUrlWithUtm}\nhttps://medcityai.com\n@MedCityAI`;

				const html = `
					<!-- Hero Section -->
					<div class="article-hero">
						<div class="article-hero-content">
							<h1 class="article-title">${escapeHtml(title)}</h1>
							<div class="article-metadata-bar">
								<div class="metadata-item">
									<i class="fas fa-calendar-alt"></i>
									<span>${pubdate}</span>
								</div>
								<div class="metadata-item">
									<i class="fas fa-book"></i>
									<span>${escapeHtml(journal)}</span>
								</div>
								<div class="metadata-item">
									<i class="fas fa-bookmark"></i>
									<span>PMID: ${pmid}</span>
								</div>
							</div>
						</div>
					</div>

					<!-- Main Content -->
					<div class="article-container">
						<!-- Buttons -->
						<div class="action-buttons">
							<a href="${url}" target="_blank" class="btn btn-primary">
								<i class="fas fa-external-link-alt"></i>
								View on PubMed
							</a>
							<button class="btn btn-linkedin" onclick="shareOnLinkedIn('${encodeURIComponent(linkedinShareText)}', '${encodeURIComponent(pubmedUrlWithUtm)}')">
								<i class="fab fa-linkedin"></i>
								Share on LinkedIn
							</button>
							<button class="btn btn-secondary" onclick="copyToClipboard('${escapeHtml(linkedinShareText).replace(/'/g, "\\'")}')">
								<i class="fas fa-copy"></i>
								Copy Share Text
							</button>
						</div>

						<!-- Main Card -->
						<div class="article-main-card">
							<!-- Specialties -->
							${specialtyHtml ? `
							<div class="specialties-section">
								<div class="section-title">
									<i class="fas fa-tag"></i> Specialties
								</div>
								<div class="specialty-badges">
									${specialtyHtml}
								</div>
							</div>
							` : ''}

							<!-- Authors -->
							<div class="authors-section">
								<div class="section-title">
									<i class="fas fa-users"></i> Authors
								</div>
								<div class="authors-list">
									${authorsHtml || '<p style="color: #7f8c8d;">No author information available.</p>'}
								</div>
							</div>

							<!-- Citation Info -->
							<div class="citation-info">
								<strong>Citation:</strong> ${escapeHtml(journal)}, ${pubdate} ${year ? `(${year})` : ''}
								<br><strong>PMID:</strong> <a href="${url}" target="_blank" style="color: #667eea;">${pmid}</a>
							</div>

							<!-- Abstract -->
							${abstract ? `
							<div>
								<div class="section-title">
									<i class="fas fa-file-alt"></i> Abstract
								</div>
								<div class="abstract-section">
									${escapeHtml(abstract)}
								</div>
							</div>
							` : ''}

							<!-- AI Summary -->
							${llmSummary && llmSummary !== 'No abstract available.' ? `
							<div>
								<div class="ai-summary-header">
									<h3>
										<i class="fas fa-brain"></i> AI Summary
									</h3>
									<span class="ai-badge">AI GENERATED</span>
								</div>
								<div class="ai-summary-section">
									<div class="ai-summary-content">
										${escapeHtml(llmSummary)}
									</div>
									<div class="ai-disclaimer">
										<strong><i class="fas fa-exclamation-circle"></i> Important Disclaimer:</strong>
										This summary was generated by artificial intelligence and may contain inaccuracies, omissions, or misinterpretations. 
										Always refer to the full publication for accurate and complete information. This summary is provided for convenience and 
										educational purposes only and should not be used as a substitute for reading the original research.
									</div>
								</div>
							</div>
							` : ''}
						</div>
					</div>
				`;

				container.innerHTML = html;
			}

			// Helper functions
			function escapeHtml(text) {
				if (!text) return '';
				const div = document.createElement('div');
				div.textContent = text;
				return div.innerHTML;
			}

			function getLastTwoSentences(text) {
				if (!text) return '';
				const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
				if (sentences.length === 0) return text.substring(0, 150) + '...';
				return sentences.slice(-2).join(' ').trim();
			}

			function shareOnLinkedIn(shareText, pubmedUrl) {
				const text = decodeURIComponent(shareText);
				navigator.clipboard.writeText(text).catch(() => {
					prompt('Copy this text to share on LinkedIn:', text);
				});
				window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${pubmedUrl}`, '_blank');
			}

			function copyToClipboard(text) {
				const cleanText = text.replace(/\\'/g, "'");
				navigator.clipboard.writeText(cleanText).then(() => {
					alert('Share text copied to clipboard!');
				}).catch(() => {
					prompt('Copy this text:', cleanText);
				});
			}

			function updateMetaTags(article) {
				// Update title
				document.title = `${article.title} - MedCityAI`;
				
				// Update Open Graph tags
				const metaTags = {
					'og:title': article.title,
					'og:description': getLastTwoSentences(article.llm_summary || article.abstract || 'Medical research article'),
					'og:url': window.location.href
				};

				Object.entries(metaTags).forEach(([property, content]) => {
					let meta = document.querySelector(`meta[property="${property}"]`);
					if (!meta) {
						meta = document.createElement('meta');
						meta.setAttribute('property', property);
						document.head.appendChild(meta);
					}
					meta.content = content;
				});
			}

			function showError(title, message, icon = 'exclamation-triangle') {
				const container = document.getElementById('articleContent');
				container.innerHTML = `
					<div class="error-state">
						<i class="fas fa-${icon}"></i>
						<h2>${title}</h2>
						<p>${message}</p>
						<a href="index.html" class="btn btn-primary" style="width: fit-content; margin: 20px auto;">
							<i class="fas fa-home"></i> Return to Feed
						</a>
					</div>
				`;
			}

			// Load article on page load
			window.addEventListener('DOMContentLoaded', loadArticle);
		</script>
	</body>
</html>
