<!DOCTYPE HTML>
<!--
	MedCityAI - Advanced Search
-->
<html>
	<head>
		<title>Search - Med City AI</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="stylesheet" href="assets/css/fontawesome-all.min.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<style>
		/* Top Navigation Bar */
		.top-bar {
			background: #ffffff;
			color: #2c3e50;
			padding: 15px 0;
			font-size: 14px;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			z-index: 1001;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			border-bottom: 1px solid #eee;
		}
		.top-bar-content {
			max-width: 1200px;
			margin: 0 auto;
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0 20px;
		}
		.logo {
			display: flex;
			align-items: center;
		}
		.logo img {
			height: 40px;
			width: auto;
		}
		.nav-links {
			display: flex;
			gap: 30px;
			align-items: center;
		}
		.nav-links a {
			color: #2c3e50;
			text-decoration: none;
			font-weight: 500;
			font-size: 15px;
			transition: color 0.3s ease;
		}
		.nav-links a:hover, .nav-links a.active {
			color: #3498db;
		}
		.cta-button {
			background: linear-gradient(135deg, #3498db, #2980b9);
			color: white;
			padding: 10px 20px;
			border-radius: 25px;
			text-decoration: none;
			font-weight: 600;
			font-size: 14px;
			transition: all 0.3s ease;
		}
		.cta-button:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
		}

		/* Search Hero Section */
		.search-hero {
			background: linear-gradient(135deg, #3a4660 0%, #4e6a8a 60%, #233045 100%);
			min-height: 300px;
			display: flex;
			align-items: center;
			justify-content: center;
			margin-top: 70px;
			padding: 60px 20px;
			position: relative;
			overflow: hidden;
		}
		.search-hero::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 400" fill="rgba(52,152,219,0.08)"><circle cx="100" cy="100" r="80"/><circle cx="300" cy="300" r="100"/></svg>') center/cover;
			opacity: 0.5;
		}
		.search-hero-content {
			max-width: 900px;
			width: 100%;
			position: relative;
			z-index: 2;
		}
		.search-hero h1 {
			color: #fff;
			font-size: 2.8em;
			font-weight: 800;
			margin-bottom: 16px;
			text-align: center;
			text-shadow: 0 2px 10px rgba(0,0,0,0.2);
		}
		.search-hero p {
			color: #e0e0e0;
			font-size: 1.1em;
			text-align: center;
			margin-bottom: 36px;
		}

		/* Advanced Search Form */
		.search-container {
			background: #fff;
			border-radius: 16px;
			padding: 32px;
			box-shadow: 0 10px 40px rgba(0,0,0,0.15);
		}
		.search-row {
			display: flex;
			gap: 16px;
			margin-bottom: 20px;
			align-items: flex-end;
		}
		.search-field {
			flex: 1;
		}
		.search-field label {
			display: block;
			font-weight: 600;
			color: #2c3e50;
			margin-bottom: 8px;
			font-size: 14px;
		}
		.search-field input, .search-field select {
			width: 100%;
			padding: 12px 16px;
			border: 2px solid #e0e0e0;
			border-radius: 8px;
			font-size: 15px;
			transition: all 0.3s ease;
			box-sizing: border-box;
		}
		.search-field input:focus, .search-field select:focus {
			outline: none;
			border-color: #3498db;
			box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
		}
		.search-field-small {
			flex: 0 0 200px;
		}
		.search-submit {
			background: linear-gradient(135deg, #3498db, #2980b9);
			color: white;
			border: none;
			padding: 14px 40px;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.search-submit:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}
		.search-submit:active {
			transform: translateY(0);
		}
		.search-filters {
			display: flex;
			gap: 12px;
			flex-wrap: wrap;
			margin-top: 20px;
			padding-top: 20px;
			border-top: 1px solid #e0e0e0;
		}
		.filter-tag {
			background: #e3f2fd;
			color: #1565c0;
			padding: 6px 14px;
			border-radius: 20px;
			font-size: 13px;
			font-weight: 500;
			display: flex;
			align-items: center;
			gap: 6px;
		}
		.filter-tag .remove {
			cursor: pointer;
			font-weight: bold;
		}

		/* Results Section */
		.results-section {
			max-width: 1000px;
			margin: 40px auto;
			padding: 0 20px;
		}
		.results-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 24px;
			padding-bottom: 16px;
			border-bottom: 1px solid #e0e0e0;
		}
		.results-count {
			font-size: 1.2em;
			color: #2c3e50;
			font-weight: 600;
		}
		.results-count span {
			color: #3498db;
		}
		.results-actions {
			display: flex;
			align-items: center;
			gap: 16px;
		}
		.select-all-container {
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.select-all-container label {
			font-weight: 500;
			color: #2c3e50;
			cursor: pointer;
			user-select: none;
		}
		.select-all-container input[type="checkbox"] {
			width: 18px;
			height: 18px;
			cursor: pointer;
		}
		.export-btn {
			background: linear-gradient(135deg, #27ae60, #229954);
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.export-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
		}
		.export-btn:disabled {
			background: #bdc3c7;
			cursor: not-allowed;
			transform: none;
		}

		/* Result Item - Sleek Sequential Design */
		.results-list {
			background: #fff;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 2px 8px rgba(0,0,0,0.08);
		}
		.result-item {
			padding: 24px;
			border-bottom: 1px solid #f0f0f0;
			transition: background 0.2s ease;
			display: flex;
			gap: 18px;
			align-items: flex-start;
			position: relative;
		}
		.result-item:last-child {
			border-bottom: none;
		}
		.result-item:hover {
			background: #f8fbff;
		}
		.result-item.selected {
			background: #e3f2fd;
		}
		.result-checkbox {
			flex-shrink: 0;
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 8px;
			min-width: 50px;
		}
		.result-checkbox input[type="checkbox"] {
			width: 24px;
			height: 24px;
			cursor: pointer;
			accent-color: #3498db;
			border: 2px solid #3498db;
			border-radius: 4px;
		}
		.result-number {
			font-size: 13px;
			color: #7f8c8d;
			font-weight: 600;
			text-align: center;
		}
		.result-content {
			flex: 1;
			min-width: 0;
		}
		.result-title {
			font-size: 1.25em;
			font-weight: 600;
			color: #0056a3;
			text-decoration: none;
			margin-bottom: 10px;
			display: block;
			line-height: 1.5;
			transition: color 0.2s ease;
		}
		.result-title:hover {
			color: #3498db;
		}
		.result-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 20px;
			margin-bottom: 14px;
			font-size: 13px;
			color: #7f8c8d;
		}
		.result-meta-item {
			display: flex;
			align-items: center;
			gap: 6px;
			background: #f8f9fa;
			padding: 4px 10px;
			border-radius: 4px;
		}
		.result-meta-item i {
			color: #3498db;
			font-size: 12px;
		}
		.result-authors {
			font-size: 14px;
			color: #555;
			margin-bottom: 14px;
			line-height: 1.6;
		}
		.result-authors u {
			color: #2980b9;
			font-weight: 600;
			text-decoration: none;
			border-bottom: 2px solid #3498db;
		}
		.result-actions {
			display: flex;
			gap: 10px;
			align-items: center;
			flex-wrap: wrap;
		}
		.btn-link {
			background: transparent;
			color: #3498db;
			text-decoration: none;
			padding: 7px 16px;
			border-radius: 6px;
			font-size: 13px;
			font-weight: 500;
			transition: all 0.2s ease;
			display: inline-flex;
			align-items: center;
			gap: 6px;
			border: 1px solid #e0e0e0;
			cursor: pointer;
		}
		.btn-link:hover {
			background: #3498db;
			color: white;
			border-color: #3498db;
			box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
		}
		.btn-link i {
			font-size: 11px;
		}
		.btn-link.primary {
			background: #3498db;
			color: white;
			border-color: #3498db;
		}
		.btn-link.primary:hover {
			background: #2980b9;
			border-color: #2980b9;
		}

		/* Citation Modal */
		.citation-modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.6);
			z-index: 2000;
			justify-content: center;
			align-items: center;
			backdrop-filter: blur(4px);
		}
		.citation-modal-content {
			background: white;
			border-radius: 16px;
			padding: 32px;
			max-width: 700px;
			width: 90%;
			max-height: 80vh;
			overflow-y: auto;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
			animation: modalSlideIn 0.3s ease-out;
		}
		@keyframes modalSlideIn {
			from {
				transform: translateY(-50px);
				opacity: 0;
			}
			to {
				transform: translateY(0);
				opacity: 1;
			}
		}
		.citation-modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 24px;
			padding-bottom: 16px;
			border-bottom: 2px solid #e0e0e0;
		}
		.citation-modal-header h3 {
			margin: 0;
			color: #2c3e50;
			font-size: 1.5em;
		}
		.citation-close {
			background: none;
			border: none;
			font-size: 28px;
			color: #95a5a6;
			cursor: pointer;
			transition: color 0.2s ease;
			padding: 0;
			width: 32px;
			height: 32px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		.citation-close:hover {
			color: #2c3e50;
		}
		.citation-tabs {
			display: flex;
			gap: 8px;
			margin-bottom: 20px;
			border-bottom: 2px solid #e0e0e0;
		}
		.citation-tab {
			background: transparent;
			border: none;
			padding: 12px 24px;
			cursor: pointer;
			font-weight: 500;
			color: #7f8c8d;
			transition: all 0.2s ease;
			border-bottom: 3px solid transparent;
			margin-bottom: -2px;
		}
		.citation-tab:hover {
			color: #3498db;
		}
		.citation-tab.active {
			color: #3498db;
			border-bottom-color: #3498db;
		}
		.citation-content {
			background: #f8f9fa;
			border: 1px solid #e0e0e0;
			border-radius: 8px;
			padding: 20px;
			margin-bottom: 16px;
			font-family: 'Courier New', monospace;
			font-size: 14px;
			line-height: 1.8;
			color: #2c3e50;
			min-height: 120px;
			white-space: pre-wrap;
			word-wrap: break-word;
		}
		.citation-actions {
			display: flex;
			gap: 12px;
		}
		.citation-copy-btn {
			background: linear-gradient(135deg, #27ae60, #229954);
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			font-size: 14px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
			gap: 8px;
		}
		.citation-copy-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
		}
		.citation-copy-btn.copied {
			background: #95a5a6;
		}

		/* Pagination */
		.pagination {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 6px;
			margin: 50px 0 30px;
			padding: 20px;
			background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
			border-radius: 12px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.06);
		}
		.pagination button {
			padding: 10px 16px;
			border: none;
			background: white;
			border-radius: 8px;
			cursor: pointer;
			font-weight: 500;
			color: #2c3e50;
			transition: all 0.3s ease;
			font-size: 14px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.08);
			min-width: 44px;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 6px;
		}
		.pagination button:hover:not(:disabled) {
			background: #3498db;
			color: white;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
		}
		.pagination button:disabled {
			opacity: 0.3;
			cursor: not-allowed;
			box-shadow: none;
		}
		.pagination button.active {
			background: linear-gradient(135deg, #3498db, #2980b9);
			color: white;
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
			font-weight: 600;
		}
		.pagination .page-num {
			min-width: 44px;
			text-align: center;
		}
		.pagination .ellipsis {
			border: none;
			background: transparent;
			cursor: default;
			box-shadow: none;
			color: #95a5a6;
			font-weight: 600;
		}
		.pagination .nav-btn {
			padding: 10px 20px;
			font-weight: 600;
		}
		.pagination .nav-btn i {
			font-size: 12px;
		}

		/* Loading Spinner */
		.loading {
			text-align: center;
			padding: 60px 20px;
		}
		.spinner {
			border: 4px solid #f0f0f0;
			border-top: 4px solid #3498db;
			border-radius: 50%;
			width: 50px;
			height: 50px;
			animation: spin 1s linear infinite;
			margin: 0 auto 20px;
		}
		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}

		/* Empty State */
		.empty-state {
			text-align: center;
			padding: 80px 20px;
		}
		.empty-state i {
			font-size: 4em;
			color: #bdc3c7;
			margin-bottom: 20px;
		}
		.empty-state h3 {
			color: #7f8c8d;
			font-size: 1.5em;
			margin-bottom: 12px;
		}
		.empty-state p {
			color: #95a5a6;
		}

		/* Responsive */
		@media (max-width: 768px) {
			.search-row {
				flex-direction: column;
			}
			.search-field-small {
				flex: 1;
			}
			.results-header {
				flex-direction: column;
				gap: 12px;
				align-items: flex-start;
			}
			.results-actions {
				width: 100%;
				justify-content: space-between;
			}
			.result-item {
				padding: 16px;
			}
			.result-content {
				font-size: 14px;
			}
			.search-hero h1 {
				font-size: 2em;
			}
			.pagination {
				flex-wrap: wrap;
			}
		}
		</style>
	</head>
	<body class="landing is-preload">
		<!-- Page Wrapper -->
		<div id="page-wrapper">
			<!-- Navigation Header -->
			<div class="top-bar">
				<div class="top-bar-content">
					<div class="logo">
						<img src="images/medcityai_logo1.png" alt="MedCityAI" style="height:48px; width:auto;" />
					</div>
					<div class="nav-links">
						<a href="search.html" class="active">Search</a>
						<a href="index.html">New Today</a>
						<a href="analytics.html">Analytics</a>
						<a href="about.html">About</a>
						<a href="contact.html">Contact</a>
					</div>
					<div style="display: flex; align-items: center; gap: 15px;">
						<a href="#subscribe" class="cta-button">Subscribe</a>
					</div>
				</div>
			</div>

			<!-- Search Hero -->
			<section class="search-hero">
				<div class="search-hero-content">
					<h1>Advanced Search</h1>
					<p>Search Rochester, MN biomedical research by topic, author, or department</p>
					
					<div class="search-container">
						<form id="searchForm">
							<div class="search-row">
								<div class="search-field">
									<label for="searchQuery">
										<i class="fas fa-search"></i> Search Query
									</label>
									<input type="text" id="searchQuery" placeholder="e.g., machine learning, cancer treatment, COVID-19..." />
								</div>
							</div>
							
							<div class="search-row">
								<div class="search-field">
									<label for="authorName">
										<i class="fas fa-user"></i> Author Name (Optional)
									</label>
									<input type="text" id="authorName" placeholder="Last name, First name or Last name First Initial" />
								</div>
								<div class="search-field">
									<label for="department">
										<i class="fas fa-building"></i> Department (Optional)
									</label>
									<input type="text" id="department" placeholder="e.g., Radiology, Cardiology, Neurology..." />
								</div>
							</div>
							
							<div class="search-row">
								<button type="submit" class="search-submit">
									<i class="fas fa-search"></i> Search
								</button>
							</div>
						</form>
					</div>
				</div>
			</section>

			<!-- Results Section -->
			<section class="results-section">
				<div id="loadingState" class="loading" style="display: none;">
					<div class="spinner"></div>
					<p style="color: #7f8c8d; font-size: 16px;">Searching PubMed...</p>
				</div>

				<div id="resultsContainer" style="display: none;">
					<div class="results-header">
						<div class="results-count">
							Found <span id="resultCount">0</span> results
						</div>
						<div class="results-actions">
							<div class="select-all-container">
								<input type="checkbox" id="selectAll" />
								<label for="selectAll">Select All</label>
							</div>
							<button class="export-btn" id="exportBtn" onclick="exportToCSV()" disabled>
								<i class="fas fa-download"></i> Export CSV
							</button>
						</div>
					</div>
					
					<div class="results-list" id="resultsContent"></div>
					
					<div id="paginationContainer" class="pagination"></div>
				</div>

				<div id="emptyState" class="empty-state">
					<i class="fas fa-search"></i>
					<h3>Start Your Search</h3>
					<p>Enter your search criteria above to find Rochester, MN research publications</p>
				</div>
			</section>

			<!-- Citation Modal -->
			<div id="citationModal" class="citation-modal">
				<div class="citation-modal-content">
					<div class="citation-modal-header">
						<h3>Citation Formats</h3>
						<button class="citation-close" onclick="closeCitationModal()">&times;</button>
					</div>
					
					<div class="citation-tabs">
						<button class="citation-tab active" onclick="switchCitationTab('mla')">MLA</button>
						<button class="citation-tab" onclick="switchCitationTab('apa')">APA</button>
						<button class="citation-tab" onclick="switchCitationTab('chicago')">Chicago</button>
						<button class="citation-tab" onclick="switchCitationTab('vancouver')">Vancouver</button>
					</div>
					
					<div id="citationText" class="citation-content"></div>
					
					<div class="citation-actions">
						<button class="citation-copy-btn" onclick="copyCitation()">
							<i class="fas fa-copy"></i> Copy Citation
						</button>
					</div>
				</div>
			</div>

			<!-- Footer -->
			<footer id="footer" style="margin-top: 80px;">
				<ul class="icons">
					<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
					<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
					<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
					<li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
				</ul>
				<ul class="copyright">
					<li>&copy; Med City AI</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
				</ul>
			</footer>
		</div>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>

		<script>
		// Application State
		let currentResults = [];
		let currentPage = 1;
		const resultsPerPage = 20;
		let totalResults = 0;
		let selectedArticles = new Set();
		let currentCitationArticle = null;
		let currentCitationStyle = 'mla';

		// Search Form Handler
		document.getElementById('searchForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			currentPage = 1;
			selectedArticles.clear();
			await performSearch();
		});

		// Select All Handler
		document.getElementById('selectAll').addEventListener('change', function(e) {
			const checkboxes = document.querySelectorAll('.article-checkbox');
			checkboxes.forEach(cb => {
				cb.checked = e.target.checked;
				const pmid = cb.dataset.pmid;
				if (e.target.checked) {
					selectedArticles.add(pmid);
					cb.closest('.result-item').classList.add('selected');
				} else {
					selectedArticles.delete(pmid);
					cb.closest('.result-item').classList.remove('selected');
				}
			});
			updateExportButton();
		});

		// Update Export Button State
		function updateExportButton() {
			const exportBtn = document.getElementById('exportBtn');
			exportBtn.disabled = selectedArticles.size === 0;
			if (selectedArticles.size > 0) {
				exportBtn.innerHTML = `<i class="fas fa-download"></i> Export CSV (${selectedArticles.size})`;
			} else {
				exportBtn.innerHTML = `<i class="fas fa-download"></i> Export CSV`;
			}
		}

		// Export to CSV
		function exportToCSV() {
			if (selectedArticles.size === 0) return;

			// Get selected articles
			const selectedData = currentResults.filter(article => selectedArticles.has(article.pmid));

			// Build CSV content
			const headers = ['PMID', 'Title', 'Authors', 'Journal', 'Publication Date', 'Abstract', 'URL'];
			let csvContent = headers.join(',') + '\n';

			selectedData.forEach(article => {
				const row = [
					article.pmid,
					`"${article.title.replace(/"/g, '""')}"`,
					`"${article.authors.replace(/"/g, '""')}"`,
					`"${article.journal.replace(/"/g, '""')}"`,
					article.pubdate,
					`"${article.abstract.replace(/"/g, '""')}"`,
					article.url
				];
				csvContent += row.join(',') + '\n';
			});

			// Create download
			const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
			const link = document.createElement('a');
			const url = URL.createObjectURL(blob);
			link.setAttribute('href', url);
			link.setAttribute('download', `pubmed_search_results_${new Date().toISOString().split('T')[0]}.csv`);
			link.style.visibility = 'hidden';
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
		}

		async function performSearch() {
			const searchQuery = document.getElementById('searchQuery').value.trim();
			const authorName = document.getElementById('authorName').value.trim();
			const department = document.getElementById('department').value.trim();

			// Show loading state
			document.getElementById('emptyState').style.display = 'none';
			document.getElementById('resultsContainer').style.display = 'none';
			document.getElementById('loadingState').style.display = 'block';

			try {
				// Build PubMed query
				let queryParts = [];
				
				// Base location filter - ALWAYS included
				queryParts.push('(Rochester[AD] AND (Minnesota[AD] OR MN[AD]))');

				// Add main search query
				if (searchQuery) {
					queryParts.push(`(${searchQuery})`);
				}

				// Add author filter
				if (authorName) {
					queryParts.push(`(${authorName}[Author])`);
				}

				// Add department filter
				if (department) {
					queryParts.push(`(${department}[Affiliation])`);
				}

				const fullQuery = queryParts.join(' AND ');

				// First, get total count to check if we need to narrow
				let countUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(fullQuery)}&retmode=json&retmax=0&sort=pub+date`;
				
				const countResponse = await fetch(countUrl);
				const countData = await countResponse.json();
				totalResults = parseInt(countData.esearchresult.count);

				let esearchUrl;
				let showNarrowNotice = false;

				// If more than 1000 results, limit to most recent 1000
				if (totalResults > 1000) {
					showNarrowNotice = true;
					// Fetch only the 1000 most recent
					esearchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(fullQuery)}&retmode=json&retmax=1000&sort=pub+date`;
				} else {
					esearchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(fullQuery)}&retmode=json&retmax=500&sort=pub+date`;
				}

				console.log('Search URL:', esearchUrl);

				// Fetch article IDs
				const searchResponse = await fetch(esearchUrl);
				const searchData = await searchResponse.json();
				
				const articleIds = searchData.esearchresult.idlist;
				const displayCount = articleIds.length;

				if (articleIds.length === 0) {
					showEmptyResults();
					return;
				}

				// Fetch article details
				const efetchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${articleIds.join(',')}&retmode=xml`;
				const fetchResponse = await fetch(efetchUrl);
				const xmlText = await fetchResponse.text();

				// Parse XML
				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
				
				currentResults = parseArticles(xmlDoc);
				displayResults();

				// Show narrowed notice if needed
				if (showNarrowNotice) {
					showNarrowedSearchNotice(totalResults, displayCount);
				}

			} catch (error) {
				console.error('Search error:', error);
				document.getElementById('loadingState').style.display = 'none';
				alert('An error occurred while searching. Please try again.');
			}
		}

		function showNarrowedSearchNotice(actualTotal, displayed) {
			const resultsContainer = document.getElementById('resultsContainer');
			const existingNotice = document.getElementById('narrowedNotice');
			if (existingNotice) {
				existingNotice.remove();
			}

			const notice = document.createElement('div');
			notice.id = 'narrowedNotice';
			notice.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 24px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3); display: flex; align-items: center; gap: 14px; font-size: 15px;';
			notice.innerHTML = `
				<i class="fas fa-info-circle" style="font-size: 1.8em; flex-shrink: 0;"></i>
				<div>
					<strong style="font-size: 16px;">Search Too Broad</strong><br>
					<span style="opacity: 0.95;">Found ${actualTotal.toLocaleString()} total results. Displaying the ${displayed.toLocaleString()} most recent publications. Please narrow your search criteria (e.g., add author, department, or more specific keywords) for more targeted results.</span>
				</div>
			`;
			
			const resultsContent = document.getElementById('resultsContent');
			resultsContainer.insertBefore(notice, resultsContent);
		}

		function parseArticles(xmlDoc) {
			const articles = [];
			const articleNodes = xmlDoc.querySelectorAll('PubmedArticle');

			articleNodes.forEach(articleNode => {
				try {
					// PMID
					const pmidNode = articleNode.querySelector('PMID');
					const pmid = pmidNode ? pmidNode.textContent : '';

					// Title
					const titleNode = articleNode.querySelector('ArticleTitle');
					const title = titleNode ? titleNode.textContent : 'No title';

					// Abstract
					const abstractNode = articleNode.querySelector('Abstract');
					let abstract = '';
					if (abstractNode) {
						const abstractTexts = abstractNode.querySelectorAll('AbstractText');
						abstract = Array.from(abstractTexts).map(node => node.textContent).join(' ');
					}

					// Journal
					const journalNode = articleNode.querySelector('Journal Title');
					let journal = journalNode ? journalNode.textContent : '';
					
					// Abbreviate journal if more than 5 words
					if (journal) {
						const journalWords = journal.split(/\s+/);
						if (journalWords.length > 5) {
							// Try to get abbreviated journal name
							const isoAbbrevNode = articleNode.querySelector('ISOAbbreviation');
							if (isoAbbrevNode && isoAbbrevNode.textContent) {
								journal = isoAbbrevNode.textContent;
							}
						}
					}

					// Publication Date
					const yearNode = articleNode.querySelector('PubDate Year');
					const monthNode = articleNode.querySelector('PubDate Month');
					const dayNode = articleNode.querySelector('PubDate Day');
					
					const year = yearNode ? yearNode.textContent : '';
					const month = monthNode ? monthNode.textContent : '';
					const day = dayNode ? dayNode.textContent : '';
					
					let pubdate = '';
					if (year && month && day) {
						pubdate = `${month} ${day}, ${year}`;
					} else if (year && month) {
						pubdate = `${month} ${year}`;
					} else if (year) {
						pubdate = year;
					}

					// Authors
					const authorNodes = articleNode.querySelectorAll('Author');
					const authors = [];
					const rochesterAuthors = [];

					authorNodes.forEach(authorNode => {
						const lastNameNode = authorNode.querySelector('LastName');
						const foreNameNode = authorNode.querySelector('ForeName');
						
						const lastName = lastNameNode ? lastNameNode.textContent : '';
						const foreName = foreNameNode ? foreNameNode.textContent : '';
						
						let authorName = '';
						if (foreName) {
							const initials = foreName.split(' ').map(n => n[0]).join(' ');
							authorName = `${lastName} ${initials}`;
						} else {
							authorName = lastName;
						}

						// Check if Rochester author
						const affiliationNodes = authorNode.querySelectorAll('Affiliation');
						let isRochester = false;
						affiliationNodes.forEach(affNode => {
							const affText = affNode.textContent.toLowerCase();
							if (affText.includes('rochester') || affText.includes('mayo')) {
								isRochester = true;
							}
						});

						if (authorName) {
							authors.push(authorName);
							if (isRochester) {
								rochesterAuthors.push(authorName);
							}
						}
					});

					// Format authors
					let authorsDisplay = authors.join(', ');
					if (authors.length > 15) {
						authorsDisplay = authors.slice(0, 14).join(', ') + ', ' + authors[authors.length - 1] + ', et al.';
					}

					articles.push({
						pmid,
						title,
						abstract: abstract || 'No abstract available.',
						journal,
						pubdate,
						year,
						authors: authorsDisplay,
						rochesterAuthors,
						url: `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`
					});

				} catch (error) {
					console.error('Error parsing article:', error);
				}
			});

			return articles;
		}

		function displayResults() {
			document.getElementById('loadingState').style.display = 'none';
			document.getElementById('resultsContainer').style.display = 'block';
			document.getElementById('emptyState').style.display = 'none';

			// Update result count
			document.getElementById('resultCount').textContent = totalResults.toLocaleString();

			// Calculate pagination
			const totalPages = Math.ceil(currentResults.length / resultsPerPage);
			const startIdx = (currentPage - 1) * resultsPerPage;
			const endIdx = Math.min(startIdx + resultsPerPage, currentResults.length);
			const pageResults = currentResults.slice(startIdx, endIdx);

			// Display results
			let resultsHTML = '';
			pageResults.forEach((article, index) => {
				// Underline Rochester authors
				let authorsHTML = article.authors;
				article.rochesterAuthors.forEach(rochAuthor => {
					authorsHTML = authorsHTML.replace(rochAuthor, `<u>${rochAuthor}</u>`);
				});

				const isSelected = selectedArticles.has(article.pmid);
				const resultNumber = startIdx + index + 1;

				resultsHTML += `
					<div class="result-item ${isSelected ? 'selected' : ''}">
						<div class="result-checkbox">
							<input type="checkbox" class="article-checkbox" data-pmid="${article.pmid}" 
								${isSelected ? 'checked' : ''} 
								onchange="toggleArticleSelection('${article.pmid}', this)">
							<div class="result-number">#${resultNumber}</div>
						</div>
						<div class="result-content">
							<a href="${article.url}" target="_blank" class="result-title">${article.title}</a>
							
							<div class="result-meta">
								<div class="result-meta-item">
									<i class="fas fa-calendar"></i>
									${article.pubdate}
								</div>
								<div class="result-meta-item">
									<i class="fas fa-book"></i>
									${article.journal}
								</div>
								<div class="result-meta-item">
									<i class="fas fa-hashtag"></i>
									${article.pmid}
								</div>
							</div>

							<div class="result-authors">
								${authorsHTML}
							</div>

							<div class="result-actions">
								<a href="${article.url}" target="_blank" class="btn-link primary">
									<i class="fas fa-external-link-alt"></i> View on PubMed
								</a>
								<button class="btn-link" onclick='showCitationModal(${JSON.stringify(article).replace(/'/g, "&apos;")})'>
									<i class="fas fa-quote-right"></i> Cite
								</button>
							</div>
						</div>
					</div>
				`;
			});

			document.getElementById('resultsContent').innerHTML = resultsHTML;

			// Update select all checkbox state
			updateSelectAllCheckbox();

			// Display pagination
			displayPagination(totalPages);

			// Scroll to results
			document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
		}

		// Toggle individual article selection
		function toggleArticleSelection(pmid, checkbox) {
			const resultItem = checkbox.closest('.result-item');
			if (checkbox.checked) {
				selectedArticles.add(pmid);
				resultItem.classList.add('selected');
			} else {
				selectedArticles.delete(pmid);
				resultItem.classList.remove('selected');
			}
			updateSelectAllCheckbox();
			updateExportButton();
		}

		// Update select all checkbox state
		function updateSelectAllCheckbox() {
			const checkboxes = document.querySelectorAll('.article-checkbox');
			const selectAllCheckbox = document.getElementById('selectAll');
			const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
			
			selectAllCheckbox.checked = checkboxes.length > 0 && checkedCount === checkboxes.length;
			selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
		}

		function displayPagination(totalPages) {
			if (totalPages <= 1) {
				document.getElementById('paginationContainer').style.display = 'none';
				return;
			}

			document.getElementById('paginationContainer').style.display = 'flex';
			
			let paginationHTML = '';

			// Previous button
			paginationHTML += `<button class="nav-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
				<i class="fas fa-chevron-left"></i> Previous
			</button>`;

			// Page numbers with smart ellipsis
			const maxVisible = 7;
			let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
			let endPage = Math.min(totalPages, startPage + maxVisible - 1);
			
			if (endPage - startPage < maxVisible - 1) {
				startPage = Math.max(1, endPage - maxVisible + 1);
			}

			// First page
			if (startPage > 1) {
				paginationHTML += `<button class="page-num ${1 === currentPage ? 'active' : ''}" onclick="changePage(1)">1</button>`;
				if (startPage > 2) {
					paginationHTML += `<button class="ellipsis" disabled>...</button>`;
				}
			}

			// Page numbers
			for (let i = startPage; i <= endPage; i++) {
				paginationHTML += `<button class="page-num ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
			}

			// Last page
			if (endPage < totalPages) {
				if (endPage < totalPages - 1) {
					paginationHTML += `<button class="ellipsis" disabled>...</button>`;
				}
				paginationHTML += `<button class="page-num ${totalPages === currentPage ? 'active' : ''}" onclick="changePage(${totalPages})">${totalPages}</button>`;
			}

			// Next button
			paginationHTML += `<button class="nav-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
				Next <i class="fas fa-chevron-right"></i>
			</button>`;

			document.getElementById('paginationContainer').innerHTML = paginationHTML;
		}

		function changePage(page) {
			const totalPages = Math.ceil(currentResults.length / resultsPerPage);
			if (page < 1 || page > totalPages) return;
			
			currentPage = page;
			displayResults();
		}

		function showEmptyResults() {
			document.getElementById('loadingState').style.display = 'none';
			document.getElementById('resultsContainer').style.display = 'none';
			document.getElementById('emptyState').style.display = 'block';
			document.getElementById('emptyState').innerHTML = `
				<i class="fas fa-search"></i>
				<h3>No Results Found</h3>
				<p>Try adjusting your search criteria or expanding the time range</p>
			`;
		}

		// Citation Modal Functions
		function showCitationModal(article) {
			currentCitationArticle = article;
			currentCitationStyle = 'mla';
			
			// Reset tabs
			document.querySelectorAll('.citation-tab').forEach(tab => tab.classList.remove('active'));
			document.querySelector('.citation-tab').classList.add('active');
			
			// Generate citation
			generateCitation();
			
			// Show modal
			document.getElementById('citationModal').style.display = 'flex';
		}

		function closeCitationModal() {
			document.getElementById('citationModal').style.display = 'none';
			currentCitationArticle = null;
		}

		function switchCitationTab(style) {
			currentCitationStyle = style;
			
			// Update active tab
			document.querySelectorAll('.citation-tab').forEach(tab => tab.classList.remove('active'));
			event.target.classList.add('active');
			
			// Generate new citation
			generateCitation();
		}

		function generateCitation() {
			if (!currentCitationArticle) return;
			
			const article = currentCitationArticle;
			let citation = '';
			
			// Parse authors
			const authors = article.authors.split(', ').filter(a => a && !a.includes('et al'));
			const firstAuthor = authors[0] || 'Unknown Author';
			const year = article.year || 'n.d.';
			
			switch(currentCitationStyle) {
				case 'mla':
					// MLA Format: Last, First. "Title." Journal, vol. #, no. #, Year, pp. #-#.
					citation = `${firstAuthor}`;
					if (authors.length > 1) {
						citation += `, et al`;
					}
					citation += `. "${article.title}" ${article.journal}, ${year}. PubMed, ${article.url}.`;
					break;
					
				case 'apa':
					// APA Format: Author, A. A. (Year). Title. Journal Name, volume(issue), pages.
					citation = `${firstAuthor}`;
					if (authors.length > 1) {
						citation += `, et al.`;
					}
					citation += ` (${year}). ${article.title} ${article.journal}. ${article.url}`;
					break;
					
				case 'chicago':
					// Chicago Format: Author. "Title." Journal Volume, no. Issue (Year): Pages.
					citation = `${firstAuthor}`;
					if (authors.length > 1) {
						citation += ` et al.`;
					}
					citation += ` "${article.title}" ${article.journal} (${year}). ${article.url}.`;
					break;
					
				case 'vancouver':
					// Vancouver Format: Author AA. Title. Journal. Year;volume(issue):pages.
					const vancouverAuthor = firstAuthor.split(' ').reverse().join(' ');
					citation = `${vancouverAuthor}`;
					if (authors.length > 1) {
						citation += `, et al`;
					}
					citation += `. ${article.title} ${article.journal}. ${year}. PMID: ${article.pmid}. Available from: ${article.url}`;
					break;
			}
			
			document.getElementById('citationText').textContent = citation;
		}

		function copyCitation() {
			const citationText = document.getElementById('citationText').textContent;
			const copyBtn = document.querySelector('.citation-copy-btn');
			
			navigator.clipboard.writeText(citationText).then(() => {
				// Show success feedback
				copyBtn.classList.add('copied');
				copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
				
				setTimeout(() => {
					copyBtn.classList.remove('copied');
					copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Citation';
				}, 2000);
			});
		}

		// Close modal when clicking outside
		document.getElementById('citationModal').addEventListener('click', function(e) {
			if (e.target === this) {
				closeCitationModal();
			}
		});
		</script>
	</body>
</html>
