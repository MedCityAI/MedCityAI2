<!DOCTYPE HTML>
<!--
	MedCityAI - Real-time research analytics
-->
<html>
	<head>
		<title>Med City AI</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<style>
		/* Modal for abstracts */
		.modal-bg {
			display: none;
			position: fixed;
			top: 0; left: 0; width: 100vw; height: 100vh;
			background: rgba(0,0,0,0.5);
			z-index: 3000;
			justify-content: center;
			align-items: center;
		}
		.modal-content {
			background: #fff;
			border-radius: 10px;
			max-width: 600px;
			width: 90vw;
			max-height: 80vh;
			overflow-y: auto;
			padding: 32px 24px 24px 24px;
			box-shadow: 0 4px 24px rgba(0,0,0,0.18);
			position: relative;
		}
		.modal-close {
			position: absolute;
			top: 12px;
			right: 18px;
			font-size: 22px;
			color: #333;
			cursor: pointer;
			font-weight: bold;
		}
		.modal-abstract {
			margin-top: 18px;
			font-size: 15px;
			color: #222;
			line-height: 1.6;
		}
		.modal-abstract h4 {
			color: #0056a3;
			margin-top: 15px;
			margin-bottom: 10px;
			font-size: 16px;
		}
		.modal-abstract strong {
			color: #333;
		}
		.llm-summary {
			margin-top: 20px;
			padding: 20px;
			background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
			border-radius: 8px;
			border-left: 4px solid #e74c3c;
		}
		.llm-summary h4 {
			color: #e74c3c !important;
			margin-top: 0 !important;
			margin-bottom: 12px !important;
		}
		.llm-loading {
			text-align: center;
			padding: 20px;
			color: #666;
			font-style: italic;
		}
		.llm-loading::after {
			content: '...';
			animation: dots 1.5s steps(4, end) infinite;
		}
		@keyframes dots {
			0%, 20% { content: '.'; }
			40% { content: '..'; }
			60%, 100% { content: '...'; }
		}

		/* Research results grid */
		.results {
			max-width: 1200px;
			margin: 40px auto;
			padding: 0 20px;
			column-count: 3;
			column-gap: 20px;
		}
		.result-item {
			background: #fff;
			border-radius: 10px;
			padding: 20px;
			margin: 0 0 20px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.05);
			display: inline-block;
			width: 100%;
			box-sizing: border-box;
			position: relative;
		}
		.new-tab {
			position: absolute;
			top: 0;
			left: 0;
			background: #e74c3c;
			color: #fff;
			font-size: 12px;
			font-weight: bold;
			padding: 4px 12px;
			border-radius: 8px 0 8px 0;
			z-index: 10;
		}
		.result-title {
			display: block;
			font-size: 18px;
			font-weight: 600;
			color: #0056a3;
			text-decoration: none;
			margin-bottom: 8px;
		}
		.result-title:hover { 
			text-decoration: underline; 
		}
		.result-authors { 
			color: #333; 
			font-size: 14px; 
			margin-bottom: 6px; 
		}
		.result-citation { 
			color: #666; 
			font-size: 13px; 
			margin-bottom: 10px; 
		}

		/* Share buttons */
		.share-buttons { 
			margin-top: 10px; 
		}
		.share-buttons a {
			display: inline-block;
			margin-right: 10px;
			font-size: 20px;
			color: #5e5e5e;
			padding: 6px 10px;
			border-radius: 6px;
			text-decoration: none;
			transition: opacity 0.3s ease;
		}
		.share-buttons a:hover { 
			opacity: 0.85; 
		}

		/* Top Navigation Bar */
		.top-bar {
			background: #ffffff;
			color: #2c3e50;
			padding: 15px 0;
			font-size: 14px;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			z-index: 1001;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			border-bottom: 1px solid #eee;
		}
		.top-bar-content {
			max-width: 1200px;
			margin: 0 auto;
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 0 20px;
		}
		.logo {
			display: flex;
			align-items: center;
		}
		.logo img {
			height: 40px;
			width: auto;
		}
		.nav-links {
			display: flex;
			gap: 30px;
			align-items: center;
		}
		.nav-links a {
			color: #2c3e50;
			text-decoration: none;
			font-weight: 500;
			font-size: 15px;
			transition: color 0.3s ease;
		}
		.nav-links a:hover {
			color: #3498db;
		}
		.cta-button {
			background: linear-gradient(135deg, #3498db, #2980b9);
			color: white;
			padding: 10px 20px;
			border-radius: 25px;
			text-decoration: none;
			font-weight: 600;
			font-size: 14px;
			transition: all 0.3s ease;
		}
		.cta-button:hover {
			transform: translateY(-1px);
			box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
		}
		.menu-icon {
			display: none;
			flex-direction: column;
			cursor: pointer;
		}
		.menu-icon div {
			width: 25px;
			height: 3px;
			background: #2c3e50;
			margin: 3px 0;
			transition: 0.3s;
		}

		/* Hero section */
		   .hero-section {
			   background: linear-gradient(135deg, #3a4660 0%, #4e6a8a 60%, #233045 100%);
			   min-height: 340px;
			   display: flex;
			   align-items: center;
			   position: relative;
			   overflow: hidden;
			   margin-top: 70px;
			   z-index: 1;
		   }
		   .hero-bg-blobs {
			   position: absolute;
			   top: 0;
			   left: 0;
			   width: 100%;
			   height: 100%;
			   z-index: 0;
			   pointer-events: none;
			   opacity: 1;
			   transition: opacity 0.5s;
		   }

		/* Extend the backdrop into the results grid section */
		#one.wrapper.style1.special {
			background: linear-gradient(135deg, #e3eaf3 0%, #b6c7e0 100%);
			z-index: 0;
		}
		.hero-section::before {
			content: '';
			position: absolute;
			top: 0;
			right: 0;
			width: 50%;
			height: 100%;
			background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 600" fill="rgba(52,152,219,0.05)"><circle cx="300" cy="150" r="100"/><circle cx="350" cy="400" r="80"/><path d="M200,100 Q300,200 400,300" stroke="rgba(52,152,219,0.1)" stroke-width="3" fill="none"/></svg>') center/cover;
			z-index: 1;
		}
		.hero-content {
			max-width: 1200px;
			margin: 0 auto;
			   padding: 36px 20px;
			display: grid;
			grid-template-columns: 1fr 450px;
			gap: 60px;
			align-items: center;
			position: relative;
			z-index: 2;
		}
		.hero-right {
			position: relative;
		}
		.chart-container {
			position: relative;
			aspect-ratio: 1;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.hero-left h1 {
			font-size: 3em;
			font-weight: 800;
			color: #2c3e50;
			margin-bottom: 24px;
			line-height: 1.1;
		}
		.hero-left .subtitle {
			font-size: 1.2em;
			color: #7f8c8d;
			margin-bottom: 16px;
			font-weight: 500;
		}
		.hero-left p {
			font-size: 1.1em;
			color: #34495e;
			margin-bottom: 36px;
			line-height: 1.7;
		}
		.button-row {
			display: flex;
			gap: 16px;
			flex-wrap: wrap;
		}
		.btn {
			padding: 14px 28px;
			border-radius: 50px;
			font-weight: 600;
			text-decoration: none;
			transition: all 0.3s ease;
			border: none;
			cursor: pointer;
			font-size: 15px;
		}
		.btn-primary {
			background: linear-gradient(135deg, #3498db, #2980b9);
			color: white;
			box-shadow: 0 4px 16px rgba(52, 152, 219, 0.3);
		}
		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
		}
		.btn-secondary {
			background: rgba(255, 255, 255, 0.1);
			color: white;
			border: 2px solid rgba(255, 255, 255, 0.3);
		}
		.btn-secondary:hover {
			background: rgba(255, 255, 255, 0.2);
			border-color: rgba(255, 255, 255, 0.5);
		}

		/* Stats card */
		.stats-card {
			background: #ffffff;
			border-radius: 15px;
			padding: 30px 24px;
			box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
			border: 1px solid #e8f4f8;
			position: relative;
		}
		.stats-card::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 4px;
			background: linear-gradient(90deg, #3498db, #2980b9, #3498db);
			border-radius: 20px 20px 0 0;
			animation: shimmer 3s ease-in-out infinite;
		}
		@keyframes shimmer {
			0%, 100% { opacity: 0.6; }
			50% { opacity: 1; }
		}
		.daily-count {
			display: flex;
			align-items: center;
			margin-bottom: 20px;
			padding-bottom: 16px;
			border-bottom: 1px solid #eee;
		}
		.daily-count h3 {
			margin: 0;
			font-size: 1.1em;
			color: #2c3e50;
			font-weight: 600;
		}
		.count-number {
			font-size: 2.4em;
			font-weight: 800;
			color: #3498db;
			margin-left: 12px;
		}
		.ai-summary h4 {
			margin: 0 0 12px 0;
			color: #2c3e50;
			font-size: 1.1em;
			font-weight: 600;
			display: flex;
			align-items: center;
		}
		.ai-summary h4::before {
			content: 'ü§ñ';
			margin-right: 8px;
		}
		.summary-text {
			color: #34495e;
			line-height: 1.6;
			font-size: 14px;
		}
		.update-time {
			margin-top: 16px;
			padding-top: 12px;
			border-top: 1px solid #eee;
			font-size: 12px;
			color: #7f8c8d;
			text-align: center;
		}

		/* Responsive design */
		@media (max-width: 900px) {
			.results { column-count: 2; }
			.hero-content {
				grid-template-columns: 1fr;
				gap: 40px;
				text-align: center;
			}
			.chart-container {
				display: none;
			}
			.hero-left h1 { font-size: 2.4em; }
			.hero-left p { font-size: 1.1em; }
			.nav-links {
				display: none;
			}
			.menu-icon {
				display: flex;
			}
		}
		@media (max-width: 600px) {
			.results { column-count: 1; }
			.hero-content {
				padding: 40px 15px;
			}
			.hero-left h1 { font-size: 2em; }
			.hero-left p { font-size: 1em; }
			.button-row {
				justify-content: center;
			}
			.btn {
				padding: 12px 24px;
				font-size: 14px;
			}
			.chart-container {
				display: none;
			}

			.stats-card {
				padding: 24px 18px;
			}
			.count-number { font-size: 2em; }
		}
		</style>
	</head>
	<body class="landing is-preload">
		<!-- Page Wrapper -->
		<div id="page-wrapper">
			<!-- Modern Medical Navigation Header -->
			<div class="top-bar">
				<div class="top-bar-content">
					<div class="logo">
						<img src="images/medcityai_logo1.png" alt="MedCityAI" style="height:48px; width:auto;" />
					</div>
					<div class="nav-links">
						<a href="index.html">Research</a>
						<a href="analytics.html">Analytics</a>
						<a href="about.html">About</a>
						<a href="contact.html">Contact</a>
					</div>
					<div style="display: flex; align-items: center; gap: 15px;">
						<a href="#subscribe" class="cta-button">Subscribe</a>
						<div class="menu-icon">
							<div></div>
							<div></div>
							<div></div>
						</div>
					</div>
				</div>
			</div>

			<!-- Hero Section -->
			<section class="hero-section" style="position:relative; overflow:hidden;">
				<!-- Animated SVG background blobs -->
				   <svg class="hero-bg-blobs" width="100%" height="900" viewBox="0 0 1440 900" style="position:absolute;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;">
					   <defs>
						   <linearGradient id="blobGradient1" x1="0" y1="0" x2="1" y2="1">
							   <stop offset="0%" stop-color="#3498db" stop-opacity="0.18"/>
							   <stop offset="100%" stop-color="#b6c7e0" stop-opacity="0.12"/>
						   </linearGradient>
						   <linearGradient id="blobGradient2" x1="0" y1="1" x2="1" y2="0">
							   <stop offset="0%" stop-color="#e3eaf3" stop-opacity="0.16"/>
							   <stop offset="100%" stop-color="#2980b9" stop-opacity="0.10"/>
						   </linearGradient>
					   </defs>
					   <g>
						   <circle id="blob1" cx="330" cy="220" r="330" fill="url(#blobGradient1)">
							   <animate attributeName="cx" values="330;1110;330" dur="15s" repeatCount="indefinite"/>
							   <animate attributeName="cy" values="220;680;220" dur="13.125s" repeatCount="indefinite"/>
						   </circle>
						   <circle id="blob2" cx="270" cy="180" r="270" fill="url(#blobGradient2)">
							   <animate attributeName="cx" values="270;1170;270" dur="16.875s" repeatCount="indefinite"/>
							   <animate attributeName="cy" values="180;720;180" dur="11.25s" repeatCount="indefinite"/>
						   </circle>
						   <circle id="blob3" cx="450" cy="450" r="450" fill="url(#blobGradient1)" opacity="0.7">
							   <animate attributeName="cx" values="450;990;450" dur="18.75s" repeatCount="indefinite"/>
							   <animate attributeName="cy" values="450;850;450" dur="15s" repeatCount="indefinite"/>
						   </circle>
					   </g>
				   </svg>
				<div class="hero-content">
					<div class="hero-left">
						<div class="subtitle" style="color:#e0e0e0;">Rochester, Minnesota</div>
						<h1 style="color:#fff; text-shadow: 0 4px 18px rgba(0,0,0,0.28);">What's New in Med City?</h1>
						<p style="color:#e0e0e0;">MedCityAI is a real-time feed of biomedical research from Rochester, MN. All information freely sourced from the National Library of Medicine (PubMed).</p>
						<form class="search-bar" id="searchForm" style="display: flex; gap: 12px; margin-bottom: 24px;">
							<div style="position:relative; flex:1; display:flex; align-items:center;">
								<span style="position:absolute;left:18px;top:50%;transform:translateY(-50%);color:#aaa;font-size:1.3em;pointer-events:none;">
									<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
								</span>
								<input type="text" id="searchInput" placeholder="Search topics, authors, or keywords (e.g., AI, radiology, oncology)..." style="width:100%;padding:14px 18px 14px 48px;border-radius:30px;border:1px solid #ccc;font-size:16px;display:flex;align-items:center;">
							</div>
						</form>
					</div>
					<div class="hero-right">
						<div class="chart-container">
							<img src="images/med_city_publications_web.png" alt="Rochester Publications Growth Chart" style="width: 100%; height: 100%; object-fit: contain;">
						</div>
					</div>
				</div>
			</section>

						<!-- Main Content Section -->
						<section id="one" class="wrapper style1 special" style="padding: 40px 0;">
				<!-- Results Grid -->
				<div id="pubmed-results" style="margin-top:40px;"></div>
				
				<!-- Pagination Controls -->
				<div id="pagination-controls" style="display:none; text-align:center; margin: 30px 0; padding: 20px;">
					<button id="prevPage" style="padding:12px 24px; margin:0 10px; border-radius:25px; border:1px solid #3498db; background:white; color:#3498db; cursor:pointer; font-weight:600;">‚Üê Previous</button>
					<span id="pageInfo" style="margin:0 20px; font-size:16px; color:#2c3e50; font-weight:500;">Page 1</span>
					<button id="nextPage" style="padding:12px 24px; margin:0 10px; border-radius:25px; border:1px solid #3498db; background:white; color:#3498db; cursor:pointer; font-weight:600;">Next ‚Üí</button>
				</div>

				<!-- Modal for abstracts -->
				<div id="modalBg" class="modal-bg">
					<div class="modal-content">
						<span class="modal-close" id="modalClose">&times;</span>
						<h3 id="modalTitle"></h3>
						<div class="modal-abstract" id="modalAbstract"></div>
					</div>
				</div>
			</section>

			<!-- Footer -->
			<footer id="footer">
				<ul class="icons">
					<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
					<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
					<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
					<li><a href="#" class="icon brands fa-dribbble"><span class="label">Dribbble</span></a></li>
					<li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
				</ul>
				<ul class="copyright">
					<li>&copy; Med City AI</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
				</ul>
			</footer>
		</div>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>

		<script>
		// Application state
		let VarTot = 0, VarDay = 0, VarWeek = 0, VarMonth = 0;
		let pubmedSummaryData = new Map(); // Store PMID -> LLM summary data
		let currentPage = 1;
		let currentSearchQuery = '';
		let allArticleIds = [];
		const resultsPerPage = 50;

		// Load LLM summaries from CSV
		async function loadLLMSummaries() {
			try {
				const response = await fetch('./database/pubmed_results2.csv');
				if (!response.ok) throw new Error('pubmed_results2.csv not found');
				
				const csvText = await response.text();
				const lines = csvText.split('\n');
				
				// Skip header line and process data
				for (let i = 1; i < lines.length; i++) {
					if (lines[i].trim() === '') continue;
					
					// Parse CSV line - handle commas in quoted fields
					const line = lines[i];
					const columns = [];
					let current = '';
					let inQuotes = false;
					
					for (let j = 0; j < line.length; j++) {
						const char = line[j];
						if (char === '"') {
							inQuotes = !inQuotes;
						} else if (char === ',' && !inQuotes) {
							columns.push(current.trim());
							current = '';
						} else {
							current += char;
						}
					}
					columns.push(current.trim()); // Add last column
					
					if (columns.length >= 8) { // Ensure we have all expected columns
						const pmid = columns[0];
						const llmSummary = columns[7]; // llm_summary is the 8th column (index 7)
						
						if (pmid && llmSummary && llmSummary !== 'LLM summary not generated') {
							pubmedSummaryData.set(pmid, llmSummary);
						}
					}
				}
				
				console.log(`Loaded ${pubmedSummaryData.size} LLM summaries`);
			} catch (err) {
				console.error('Error loading LLM summaries:', err);
			}
		}

		// Modal functions
		function showAbstractModal(link) {
			const modalBg = document.getElementById('modalBg');
			const modalTitle = document.getElementById('modalTitle');
			const modalAbstract = document.getElementById('modalAbstract');
			
			const title = link.getAttribute('data-title');
			const abstract = link.getAttribute('data-abstract');
			const pmid = link.getAttribute('data-pmid');
			const authors = link.getAttribute('data-authors');
			const affiliations = link.getAttribute('data-affiliations');

			// Title in black at top
			modalTitle.innerHTML = `<span style='color:#111;font-weight:800;font-size:1.3em;'>${title}</span>`;

			// Authors and affiliations
			let authorList = '';
			if (authors) {
				authorList += `<div style='margin:10px 0 18px 0;font-size:1em;color:#222;'><strong>Authors:</strong> ${authors.replace(/;/g, '; ')}</div>`;
			}
			if (affiliations) {
				authorList += `<div style='margin-bottom:18px;font-size:0.95em;color:#444;'><strong>Affiliations:</strong> ${affiliations.replace(/;/g, '; ')}</div>`;
			}

			// Start with authors, affiliations, then abstract
			let content = `${authorList}<h4>Abstract</h4><p>${abstract}</p>`;

			// Add placeholder for LLM summary
			content += `<div class="llm-summary" id="llmSummarySection">
				<h4>ü§ñ AI Summary</h4>
				<div class="llm-loading">Generating plain-language summary</div>
			</div>`;

			modalAbstract.innerHTML = content;
			modalBg.style.display = 'flex';

			// Prevent scroll to top
			if (window.scrollY) {
				setTimeout(() => window.scrollTo({top: window.scrollY}), 0);
			}

			// Call backend to generate LLM summary
			generateLLMSummary(pmid, title, abstract);
		}

		// Function to call backend API for LLM summary
		async function generateLLMSummary(pmid, title, abstract) {
			try {
				const response = await fetch('http://localhost:5000/MedCityAI/query_pubmed', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						pmid: pmid,
						title: title,
						abstract: abstract
					})
				});

				if (!response.ok) {
					throw new Error('Backend server error');
				}

				const data = await response.json();
				
				// Update the LLM summary section
				const summarySection = document.getElementById('llmSummarySection');
				if (summarySection && data.summary) {
					summarySection.innerHTML = `
						<h4>ü§ñ AI Summary</h4>
						<p style="line-height:1.7; color:#222;">${data.summary}</p>
					`;
				}

			} catch (error) {
				console.error('Error generating LLM summary:', error);
				const summarySection = document.getElementById('llmSummarySection');
				if (summarySection) {
					summarySection.innerHTML = `
						<h4>ü§ñ AI Summary</h4>
						<p style="color:#666; font-style:italic;">Unable to generate summary. Make sure the backend server is running at http://localhost:5000</p>
					`;
				}
			}
		}

		function closeModal() {
			document.getElementById('modalBg').style.display = 'none';
		}

		// Statistics loading
		async function loadStatistics() {
			try {
				const response = await fetch('./database/summary_stats.txt');
				if (!response.ok) throw new Error('Statistics file not found');
				
				const statsText = await response.text();
				statsText.split('\n').forEach(line => {
					const [key, value] = line.split('=');
					if (key && value) {
						const trimmedKey = key.trim();
						const numValue = parseInt(value.trim());
						
						switch(trimmedKey) {
							case 'VarTot': VarTot = numValue; break;
							case 'VarDay': VarDay = numValue; break;
							case 'VarWeek': VarWeek = numValue; break;
							case 'VarMonth': VarMonth = numValue; break;
						}
					}
				});

				// Update UI
				document.getElementById("VarTot").textContent = VarTot;
				document.getElementById("VarDay").textContent = VarDay;
				document.getElementById("VarWeek").textContent = VarWeek;
				document.getElementById("VarMonth").textContent = VarMonth;
				
				// Update live count in hero banner
				document.getElementById("live-count").textContent = VarDay;
			} catch (err) {
				console.error('Error loading statistics:', err);
			}
		}

		// PubMed data fetching with search query
		async function fetchPubMedResults(searchQuery = '', page = 1) {
			currentSearchQuery = searchQuery;
			currentPage = page;
			
			const baseLocation = '("Rochester"[AD] AND ("Minnesota"[AD] OR "MN"[AD]))';
			let searchTerm = baseLocation;
			
			// Add user search query if provided
			if (searchQuery && searchQuery.trim() !== '') {
				searchTerm = `(${searchQuery.trim()}) AND ${baseLocation}`;
			}
			
			// If no search query (empty), show last day. With search query, get all time results
			const hasSearchQuery = searchQuery && searchQuery.trim() !== '';
			const reldate = hasSearchQuery ? undefined : 1; // 1 day for default, all time for searches
			const retmax = hasSearchQuery ? 1000 : 100; // Get more IDs for pagination
			
			// Build URL - only include reldate and datetype for default (no search) view
			let esearchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(searchTerm)}&sort=pub+date&retmode=json&retmax=${retmax}`;
			if (!hasSearchQuery) {
				esearchUrl += `&datetype=pdat&reldate=${reldate}`;
			}

			try {
				// Get article IDs
				const esearchRes = await fetch(esearchUrl);
				const esearchData = await esearchRes.json();
				allArticleIds = esearchData.esearchresult.idlist || [];

				if (allArticleIds.length === 0) {
					document.getElementById("pubmed-results").innerHTML = "<p style='text-align:center; padding:40px; color:#666;'>No results found. Try a different search term.</p>";
					document.getElementById("pagination-controls").style.display = 'none';
					return;
				}

				// Calculate pagination
				const totalPages = Math.ceil(allArticleIds.length / resultsPerPage);
				const startIdx = (page - 1) * resultsPerPage;
				const endIdx = Math.min(startIdx + resultsPerPage, allArticleIds.length);
				const pageIds = allArticleIds.slice(startIdx, endIdx);

				// Show/hide pagination controls
				if (searchQuery && searchQuery.trim() !== '' && allArticleIds.length > resultsPerPage) {
					document.getElementById("pagination-controls").style.display = 'block';
					document.getElementById("pageInfo").textContent = `Page ${page} of ${totalPages} (${allArticleIds.length} results)`;
					document.getElementById("prevPage").disabled = page === 1;
					document.getElementById("nextPage").disabled = page === totalPages;
					document.getElementById("prevPage").style.opacity = page === 1 ? '0.5' : '1';
					document.getElementById("nextPage").style.opacity = page === totalPages ? '0.5' : '1';
				} else {
					document.getElementById("pagination-controls").style.display = 'none';
				}

				// Fetch article details
				const efetchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${pageIds.join(",")}&retmode=xml`;
				const efetchRes = await fetch(efetchUrl);
				const efetchXml = await efetchRes.text();
				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(efetchXml, "text/xml");

				// Get current date for NEW badge logic
				const now = new Date();
				const twoDaysAgo = new Date(now.getTime() - (2 * 24 * 60 * 60 * 1000));

				// Build results
				let resultsHTML = '';
				const articles = xmlDoc.querySelectorAll("PubmedArticle");
				
				articles.forEach(article => {
					const pmid = article.querySelector("PMID")?.textContent || "";
					const title = article.querySelector("ArticleTitle")?.textContent || "No title";
					const abstract = article.querySelector("Abstract")?.textContent || "No abstract available.";
					
					// Journal information
					let journal = article.querySelector("Journal > Title")?.textContent || "";
					const journalAbbr = article.querySelector("Journal > ISOAbbreviation")?.textContent || "";
					if (journal.split(/\s+/).length > 10 && journalAbbr) {
						journal = journalAbbr;
					}
					
					// Publication date
					const year = article.querySelector("PubDate Year")?.textContent || "";
					let month = article.querySelector("PubDate Month")?.textContent || "";
					const day = article.querySelector("PubDate Day")?.textContent || "";
					
					const monthNames = ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
					if (/^\d+$/.test(month)) {
						month = monthNames[parseInt(month, 10)];
					}
					
					let pubdate = "";
					let articleDate = null;
					if (year && month && day) {
						pubdate = `${month} ${day}, ${year}`;
						const monthNum = monthNames.indexOf(month);
						if (monthNum > 0) {
							articleDate = new Date(year, monthNum - 1, day);
						}
					} else if (year && month) {
						pubdate = `${month}, ${year}`;
						const monthNum = monthNames.indexOf(month);
						if (monthNum > 0) {
							articleDate = new Date(year, monthNum - 1, 1);
						}
					} else if (year) {
						pubdate = year;
					}

					// Determine if article is NEW (within last 2 days)
					const isNew = articleDate && articleDate >= twoDaysAgo;

					// Authors
					const authors = [];
					const affiliationsList = [];
					const authorNodes = Array.from(article.querySelectorAll("Author"));
					authorNodes.forEach(authorNode => {
						const lastName = authorNode.querySelector("LastName")?.textContent || "";
						const foreName = authorNode.querySelector("ForeName")?.textContent || "";
						const initials = foreName.split(" ").map(n => n[0]).join("");
						const name = `${lastName}${initials ? " " + initials : ""}`;

						const affiliations = [];
						authorNode.querySelectorAll("Affiliation").forEach(aff => {
							const affText = aff.textContent;
							affiliations.push(affText);
							if (!affiliationsList.includes(affText)) {
								affiliationsList.push(affText);
							}
						});

						let displayName = name;
						if (affiliations.some(a => /Rochester|Mayo/i.test(a))) {
							displayName = `<u>${displayName}</u>`;
						}
						if (name) authors.push(displayName);
					});

					let authorsHtml = "";
					if (authors.length > 16) {
						authorsHtml = authors.slice(0, 15).join(", ") + ", " + authors[authors.length - 1] + ", <i>et al.</i>";
					} else {
						authorsHtml = authors.join(", ");
					}

					const citation = `${journal}. ${pubdate}. PMID: ${pmid}`;
					const url = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;

					resultsHTML += `
						<div class="result-item">
							${isNew ? '<div class="new-tab">NEW</div>' : ''}
							<br><a href="#" class="result-title" 
								data-title="${title.replace(/"/g,'&quot;')}" 
								data-abstract="${abstract.replace(/"/g,'&quot;')}" 
								data-pmid="${pmid}"
								data-authors="${authors.join(';').replace(/"/g,'&quot;')}"
								data-affiliations="${affiliationsList.join(';').replace(/"/g,'&quot;')}"
								onclick="showAbstractModal(this); return false;">${title}</a>
							<div class="result-authors">${authorsHtml}</div>
							<div class="result-citation"><em>${citation}</em></div>
							<div class="share-buttons">
								<a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" class="facebook" target="_blank">
									<i class="icon brands fa-facebook-f"></i> 
								</a>
								<a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}" class="twitter" target="_blank">
									<i class="icon brands fa-twitter"></i> 
								</a>
								<a href="https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}" class="linkedin" target="_blank">
									<i class="icon brands fa-linkedin"></i> 
								</a>
							</div>
						</div>
					`;
				});

				document.getElementById("pubmed-results").innerHTML = `<div class="results">${resultsHTML}</div>`;
				
				// Scroll to top of results after page change
				if (page > 1) {
					document.getElementById("pubmed-results").scrollIntoView({ behavior: 'smooth', block: 'start' });
				}
			} catch (error) {
				console.error('Error fetching PubMed results:', error);
				document.getElementById("pubmed-results").innerHTML = "<p style='text-align:center; padding:40px; color:#e74c3c;'>Error fetching results. Please try again.</p>";
			}
		}

		// Initialize application
		document.addEventListener('DOMContentLoaded', function() {
			// Set up modal event listeners
			const modalBg = document.getElementById('modalBg');
			const modalClose = document.getElementById('modalClose');
            
			modalClose.addEventListener('click', closeModal);
			modalBg.addEventListener('click', function(e) {
				if (e.target === modalBg) closeModal();
			});

			// Set up search form event listener
			const searchForm = document.getElementById('searchForm');
			const searchInput = document.getElementById('searchInput');
			
			searchForm.addEventListener('submit', function(e) {
				e.preventDefault();
				const query = searchInput.value.trim();
				fetchPubMedResults(query, 1);
			});

			// Set up pagination event listeners
			document.getElementById('prevPage').addEventListener('click', function() {
				if (currentPage > 1) {
					fetchPubMedResults(currentSearchQuery, currentPage - 1);
				}
			});

			document.getElementById('nextPage').addEventListener('click', function() {
				const totalPages = Math.ceil(allArticleIds.length / resultsPerPage);
				if (currentPage < totalPages) {
					fetchPubMedResults(currentSearchQuery, currentPage + 1);
				}
			});

			// Load data
			loadStatistics();
			loadLLMSummaries();
			fetchPubMedResults('', 1);
		});
		</script>
	</body>
</html>