<!DOCTYPE HTML>
<!--
	MedCityAI - Real-time research analytics
-->
<html>
	<head>
		<title>Med City AI</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<style>
		/* Modal for abstracts */
		.modal-bg {
			display: none;
			position: fixed;
			top: 0; left: 0; width: 100vw; height: 100vh;
			background: rgba(0,0,0,0.5);
			z-index: 3000;
			justify-content: center;
			align-items: center;
		}
		.modal-content {
			background: #fff;
			border-radius: 10px;
			max-width: 600px;
			width: 90vw;
			max-height: 80vh;
			overflow-y: auto;
			padding: 32px 24px 24px 24px;
			box-shadow: 0 4px 24px rgba(0,0,0,0.18);
			position: relative;
		}
		.modal-close {
			position: absolute;
			top: 12px;
			right: 18px;
			font-size: 22px;
			color: #333;
			cursor: pointer;
			font-weight: bold;
		}
		.modal-abstract {
			margin-top: 18px;
			font-size: 15px;
			color: #222;
			line-height: 1.6;
		}
		.modal-abstract h4 {
			color: #0056a3;
			margin-top: 15px;
			margin-bottom: 10px;
			font-size: 16px;
		}
		.modal-abstract strong {
			color: #333;
		}

		/* Research results grid */
		.results {
			max-width: 1100px;
			margin: 40px auto;
			column-count: 3;
			column-gap: 20px;
		}
		.result-item {
			background: #fff;
			border-radius: 10px;
			padding: 20px;
			margin: 0 0 20px;
			box-shadow: 0 2px 6px rgba(0,0,0,0.05);
			display: inline-block;
			width: 100%;
			box-sizing: border-box;
			position: relative;
		}
		.new-tab {
			position: absolute;
			top: 0;
			left: 0;
			background: #e74c3c;
			color: #fff;
			font-size: 12px;
			font-weight: bold;
			padding: 4px 12px;
			border-radius: 8px 0 8px 0;
			z-index: 10;
		}
		.result-title {
			display: block;
			font-size: 18px;
			font-weight: 600;
			color: #0056a3;
			text-decoration: none;
			margin-bottom: 8px;
		}
		.result-title:hover { 
			text-decoration: underline; 
		}
		.result-authors { 
			color: #333; 
			font-size: 14px; 
			margin-bottom: 6px; 
		}
		.result-citation { 
			color: #666; 
			font-size: 13px; 
			margin-bottom: 10px; 
		}

		/* Share buttons */
		.share-buttons { 
			margin-top: 10px; 
		}
		.share-buttons a {
			display: inline-block;
			margin-right: 10px;
			font-size: 20px;
			color: #5e5e5e;
			padding: 6px 10px;
			border-radius: 6px;
			text-decoration: none;
			transition: opacity 0.3s ease;
		}
		.share-buttons a:hover { 
			opacity: 0.85; 
		}

		/* Statistics display */
		.stats-container {
			display: flex;
			justify-content: space-around;
			text-align: center;
			margin: 3em 0 2em 0;
			background: rgba(255, 255, 255, 0.95);
			border-radius: 15px;
			padding: 40px 20px;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.2);
		}
		.stat-item {
			flex: 1;
			padding: 0 20px;
		}
		.stat-item h2 {
			margin-bottom: 0.3em;
			font-size: 3.5em;
			font-weight: 800;
			background: linear-gradient(135deg, #0056a3, #007acc);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			text-shadow: 0 2px 4px rgba(0, 86, 163, 0.2);
		}
		.stat-item p {
			font-size: 1.1em;
			color: #444;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 1px;
			margin: 0;
		}
		.hero-banner {
			background: linear-gradient(135deg, rgba(0, 86, 163, 0.9), rgba(0, 122, 204, 0.8));
			border-radius: 20px;
			padding: 50px 40px;
			margin-bottom: 30px;
			text-align: center;
			position: relative;
			overflow: hidden;
		}
		.hero-banner::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><polygon points="0,100 1000,0 1000,100"/></svg>') no-repeat bottom;
			background-size: 100% 100px;
			pointer-events: none;
		}
		.hero-title {
			font-size: 3.5em;
			font-weight: 900;
			color: white;
			margin-bottom: 20px;
			text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
			letter-spacing: -1px;
		}
		.hero-subtitle {
			font-size: 1.4em;
			color: rgba(255, 255, 255, 0.95);
			margin-bottom: 30px;
			line-height: 1.6;
			font-weight: 400;
		}
		.live-indicator {
			display: inline-flex;
			align-items: center;
			background: rgba(231, 76, 60, 0.9);
			color: white;
			padding: 12px 24px;
			border-radius: 50px;
			font-weight: 700;
			font-size: 1.1em;
			margin-bottom: 20px;
			box-shadow: 0 4px 16px rgba(231, 76, 60, 0.3);
		}
		.live-indicator::before {
			content: '';
			width: 12px;
			height: 12px;
			background: #fff;
			border-radius: 50%;
			margin-right: 10px;
			animation: pulse 2s infinite;
		}
		@keyframes pulse {
			0%, 100% { opacity: 1; transform: scale(1); }
			50% { opacity: 0.5; transform: scale(0.8); }
		}
		.cta-text {
			font-size: 1.2em;
			color: rgba(255, 255, 255, 0.9);
			font-weight: 600;
			margin-top: 10px;
		}

		/* Responsive design */
		@media (max-width: 900px) {
			.results { column-count: 2; }
			.hero-title { font-size: 2.5em; }
			.hero-subtitle { font-size: 1.2em; }
			.stat-item h2 { font-size: 2.8em; }
			.stats-container { padding: 30px 15px; }
		}
		@media (max-width: 600px) {
			.results { column-count: 1; }
			.stats-container {
				flex-direction: column;
				gap: 1.5em;
				padding: 25px 15px;
			}
			.stat-item {
				padding: 0 10px;
			}
			.hero-banner {
				padding: 40px 25px;
				margin-bottom: 25px;
			}
			.hero-title { font-size: 2em; }
			.hero-subtitle { font-size: 1.1em; }
			.stat-item h2 { font-size: 2.5em; }
		}
		</style>
	</head>
	<body class="landing is-preload">
		<!-- Page Wrapper -->
		<div id="page-wrapper">
			<!-- Header -->
			<header id="header" class="alt" style="position:fixed;top:0;left:0;width:100%;z-index:1000;background:rgba(34, 34, 34, 0.95);box-shadow:0 2px 8px rgba(0,0,0,0.07);">
				<h1><a href="index.html">Med City AI</a></h1>
				<nav id="nav">
					<ul>
						<li class="special">
							<a href="#menu" class="menuToggle"><span>Menu</span></a>
							<div id="menu">
								<ul>
									<li><a href="index.html">Home</a></li>
									<li><a href="generic.html">Generic</a></li>
									<li><a href="elements.html">Elements</a></li>
									<li><a href="#">Sign Up</a></li>
									<li><a href="#">Log In</a></li>
								</ul>
							</div>
						</li>
					</ul>
				</nav>
			</header>

			<!-- Main Section -->
			<section id="one" class="wrapper style1 special" style="background: url('images/banner.jpg') center center/cover no-repeat; background-attachment: fixed;">
				<div class="inner">
					<!-- Hero Banner -->
					<div class="hero-banner">
						<div class="live-indicator">
							ðŸ”´ LIVE FEED â€¢ <span id="live-count">0</span> NEW TODAY
						</div>
						<h1 class="hero-title">Med City AI</h1>
						<p class="hero-subtitle">
							Real-time biomedical research from Rochester, Minnesota<br>
							Fresh discoveries. Cutting-edge science. Updated every hour.
						</p>
						<div class="cta-text">Be the first to know what's happening in medical research</div>
					</div>
				
					<!-- Statistics Section -->
					<div class="stats-container">
						<div class="stat-item">
							<h2 id="VarDay">0</h2>
							<p>New Today</p>
						</div>
						<div class="stat-item">
							<h2 id="VarWeek">0</h2>
							<p>This Week</p>
						</div>
						<div class="stat-item">
							<h2 id="VarMonth">0</h2>
							<p>This Month</p>
						</div>
						<div class="stat-item">
							<h2 id="VarTot">0</h2>
							<p>Total Articles</p>
						</div>
					</div>

					<!-- Results Grid -->
					<div id="pubmed-results" style="margin-top:40px;"></div>

					<!-- Modal for abstracts -->
					<div id="modalBg" class="modal-bg">
						<div class="modal-content">
							<span class="modal-close" id="modalClose">&times;</span>
							<h3 id="modalTitle"></h3>
							<div class="modal-abstract" id="modalAbstract"></div>
						</div>
					</div>
				</div>
			</section>

			<!-- Footer -->
			<footer id="footer">
				<ul class="icons">
					<li><a href="#" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li>
					<li><a href="#" class="icon brands fa-facebook-f"><span class="label">Facebook</span></a></li>
					<li><a href="#" class="icon brands fa-instagram"><span class="label">Instagram</span></a></li>
					<li><a href="#" class="icon brands fa-dribbble"><span class="label">Dribbble</span></a></li>
					<li><a href="#" class="icon solid fa-envelope"><span class="label">Email</span></a></li>
				</ul>
				<ul class="copyright">
					<li>&copy; Med City AI</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
				</ul>
			</footer>
		</div>

		<!-- Scripts -->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>

		<script>
		// Application state
		let VarTot = 0, VarDay = 0, VarWeek = 0, VarMonth = 0;
		let pubmedSummaryData = new Map(); // Store PMID -> LLM summary data

		// Load LLM summaries from CSV
		async function loadLLMSummaries() {
			try {
				const response = await fetch('./database/pubmed_results2.csv');
				if (!response.ok) throw new Error('pubmed_results2.csv not found');
				
				const csvText = await response.text();
				const lines = csvText.split('\n');
				
				// Skip header line and process data
				for (let i = 1; i < lines.length; i++) {
					if (lines[i].trim() === '') continue;
					
					// Parse CSV line - handle commas in quoted fields
					const line = lines[i];
					const columns = [];
					let current = '';
					let inQuotes = false;
					
					for (let j = 0; j < line.length; j++) {
						const char = line[j];
						if (char === '"') {
							inQuotes = !inQuotes;
						} else if (char === ',' && !inQuotes) {
							columns.push(current.trim());
							current = '';
						} else {
							current += char;
						}
					}
					columns.push(current.trim()); // Add last column
					
					if (columns.length >= 8) { // Ensure we have all expected columns
						const pmid = columns[0];
						const llmSummary = columns[7]; // llm_summary is the 8th column (index 7)
						
						if (pmid && llmSummary && llmSummary !== 'LLM summary not generated') {
							pubmedSummaryData.set(pmid, llmSummary);
						}
					}
				}
				
				console.log(`Loaded ${pubmedSummaryData.size} LLM summaries`);
			} catch (err) {
				console.error('Error loading LLM summaries:', err);
			}
		}

		// Modal functions
		function showAbstractModal(link) {
			const modalBg = document.getElementById('modalBg');
			const modalTitle = document.getElementById('modalTitle');
			const modalAbstract = document.getElementById('modalAbstract');
			
			const title = link.getAttribute('data-title');
			const abstract = link.getAttribute('data-abstract');
			const pmid = link.getAttribute('data-pmid');
			
			modalTitle.textContent = title;
			
			// Start with the abstract
			let content = `<h4>Abstract</h4><p>${abstract}</p>`;
			
			// Check if we have an LLM summary for this PMID
			if (pubmedSummaryData.has(pmid)) {
				const llmSummary = pubmedSummaryData.get(pmid);
				try {
					// Parse the LLM summary JSON
					const summaryObj = JSON.parse(llmSummary);
					content += `<hr style="margin: 20px 0; border: 1px solid #eee;">`;
					content += `<h4>AI Summary</h4>`;
					
					if (summaryObj.main_findings) {
						content += `<p><strong>Main Findings:</strong> ${summaryObj.main_findings}</p>`;
					}
					if (summaryObj.clinical_significance) {
						content += `<p><strong>Clinical Significance:</strong> ${summaryObj.clinical_significance}</p>`;
					}
					if (summaryObj.methodology) {
						content += `<p><strong>Methodology:</strong> ${summaryObj.methodology}</p>`;
					}
					if (summaryObj.limitations) {
						content += `<p><strong>Limitations:</strong> ${summaryObj.limitations}</p>`;
					}
				} catch (e) {
					// If parsing fails, show the raw summary
					content += `<hr style="margin: 20px 0; border: 1px solid #eee;">`;
					content += `<h4>AI Summary</h4><p>${llmSummary}</p>`;
				}
			}
			
			modalAbstract.innerHTML = content;
			modalBg.style.display = 'flex';
			
			// Prevent scroll to top
			if (window.scrollY) {
				setTimeout(() => window.scrollTo({top: window.scrollY}), 0);
			}
		}

		function closeModal() {
			document.getElementById('modalBg').style.display = 'none';
		}

		// Statistics loading
		async function loadStatistics() {
			try {
				const response = await fetch('./database/summary_stats.txt');
				if (!response.ok) throw new Error('Statistics file not found');
				
				const statsText = await response.text();
				statsText.split('\n').forEach(line => {
					const [key, value] = line.split('=');
					if (key && value) {
						const trimmedKey = key.trim();
						const numValue = parseInt(value.trim());
						
						switch(trimmedKey) {
							case 'VarTot': VarTot = numValue; break;
							case 'VarDay': VarDay = numValue; break;
							case 'VarWeek': VarWeek = numValue; break;
							case 'VarMonth': VarMonth = numValue; break;
						}
					}
				});

				// Update UI
				document.getElementById("VarTot").textContent = VarTot;
				document.getElementById("VarDay").textContent = VarDay;
				document.getElementById("VarWeek").textContent = VarWeek;
				document.getElementById("VarMonth").textContent = VarMonth;
				
				// Update live count in hero banner
				document.getElementById("live-count").textContent = VarDay;
			} catch (err) {
				console.error('Error loading statistics:', err);
			}
		}

		// PubMed data fetching
		async function fetchPubMedResults() {
			const term = '("Rochester"[AD] AND ("Minnesota"[AD] OR "MN"[AD]))';
			const esearchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(term)}&sort=pub+date&retmode=json&datetype=pdat&reldate=1`;

			try {
				// Get article IDs
				const esearchRes = await fetch(esearchUrl);
				const esearchData = await esearchRes.json();
				const ids = esearchData.esearchresult.idlist;

				if (ids.length === 0) {
					document.getElementById("pubmed-results").innerHTML = "<p>No results found.</p>";
					return;
				}

				// Fetch article details
				const efetchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${ids.join(",")}&retmode=xml`;
				const efetchRes = await fetch(efetchUrl);
				const efetchXml = await efetchRes.text();
				const parser = new DOMParser();
				const xmlDoc = parser.parseFromString(efetchXml, "text/xml");

				// Build results
				let resultsHTML = '';
				const articles = xmlDoc.querySelectorAll("PubmedArticle");
				
				articles.forEach(article => {
					const pmid = article.querySelector("PMID")?.textContent || "";
					const title = article.querySelector("ArticleTitle")?.textContent || "No title";
					const abstract = article.querySelector("Abstract")?.textContent || "No abstract available.";
					
					// Journal information
					let journal = article.querySelector("Journal > Title")?.textContent || "";
					const journalAbbr = article.querySelector("Journal > ISOAbbreviation")?.textContent || "";
					if (journal.split(/\s+/).length > 10 && journalAbbr) {
						journal = journalAbbr;
					}
					
					// Publication date
					const year = article.querySelector("PubDate Year")?.textContent || "";
					let month = article.querySelector("PubDate Month")?.textContent || "";
					const day = article.querySelector("PubDate Day")?.textContent || "";
					
					const monthNames = ["", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
					if (/^\d+$/.test(month)) {
						month = monthNames[parseInt(month, 10)];
					}
					
					let pubdate = "";
					if (month && day && year) {
						pubdate = `${month} ${day}, ${year}`;
					} else if (month && year) {
						pubdate = `${month}, ${year}`;
					} else if (year) {
						pubdate = year;
					}

					// Authors
					const authors = [];
					const authorNodes = Array.from(article.querySelectorAll("Author"));
					authorNodes.forEach(authorNode => {
						const lastName = authorNode.querySelector("LastName")?.textContent || "";
						const foreName = authorNode.querySelector("ForeName")?.textContent || "";
						const initials = foreName.split(" ").map(n => n[0]).join("");
						const name = `${lastName}${initials ? " " + initials : ""}`;

						const affiliations = [];
						authorNode.querySelectorAll("Affiliation").forEach(aff => {
							affiliations.push(aff.textContent);
						});

						let displayName = name;
						if (affiliations.some(a => /Rochester|Mayo/i.test(a))) {
							displayName = `<u>${displayName}</u>`;
						}
						if (name) authors.push(displayName);
					});

					let authorsHtml = "";
					if (authors.length > 16) {
						authorsHtml = authors.slice(0, 15).join(", ") + ", " + authors[authors.length - 1] + ", <i>et al.</i>";
					} else {
						authorsHtml = authors.join(", ");
					}

					const citation = `${journal}. ${pubdate}. PMID: ${pmid}`;
					const url = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;

					resultsHTML += `
						<div class="result-item">
							<div class="new-tab">NEW</div>
							<br><a href="#" class="result-title" 
								data-title="${title.replace(/"/g,'&quot;')}" 
								data-abstract="${abstract.replace(/"/g,'&quot;')}" 
								data-pmid="${pmid}"
								onclick="showAbstractModal(this)">${title}</a>
							<div class="result-authors">${authorsHtml}</div>
							<div class="result-citation"><em>${citation}</em></div>
							<div class="share-buttons">
								<a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" class="facebook" target="_blank">
									<i class="icon brands fa-facebook-f"></i> 
								</a>
								<a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}" class="twitter" target="_blank">
									<i class="icon brands fa-twitter"></i> 
								</a>
								<a href="https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}" class="linkedin" target="_blank">
									<i class="icon brands fa-linkedin"></i> 
								</a>
							</div>
						</div>
					`;
				});

				document.getElementById("pubmed-results").innerHTML = `<div class="results">${resultsHTML}</div>`;
			} catch (error) {
				console.error('Error fetching PubMed results:', error);
				document.getElementById("pubmed-results").innerHTML = "<p>Error fetching results.</p>";
			}
		}

		// Initialize application
		document.addEventListener('DOMContentLoaded', function() {
			// Set up modal event listeners
			const modalBg = document.getElementById('modalBg');
			const modalClose = document.getElementById('modalClose');
			
			modalClose.addEventListener('click', closeModal);
			modalBg.addEventListener('click', function(e) {
				if (e.target === modalBg) closeModal();
			});

			// Load data
			loadStatistics();
			loadLLMSummaries();
			fetchPubMedResults();
		});
		</script>
	</body>
</html>