<!DOCTYPE HTML>
<html>
<head>
    <title>Med City AI - PubMed Search</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f0f0f0;
            color: #333;
        }
        header {
            background: #444;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }
        #search-container {
            padding: 1rem;
            text-align: center;
        }
        input[type="text"] {
            width: 60%;
            padding: 0.5rem;
            font-size: 1rem;
        }
        button {
            padding: 0.6rem 1rem;
            font-size: 1rem;
            margin-left: 0.5rem;
            cursor: pointer;
        }
        #counts {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1rem 0;
            font-weight: bold;
        }
        #results {
            column-count: 3;
            column-gap: 1rem;
            padding: 1rem;
        }
        .card {
            background: #fff;
            display: inline-block;
            margin: 0 0 1rem;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            width: 100%;
        }
        .title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .authors {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .abstract {
            font-size: 0.9rem;
            color: #555;
        }
        .underline {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <header>
        <h1>Med City AI - PubMed Search</h1>
    </header>

    <div id="search-container">
        <input type="text" id="query" placeholder="Enter search term..." />
        <button onclick="searchPubMed()">Search</button>
    </div>

    <div id="counts">
        <div id="count-day">Today: 0</div>
        <div id="count-week">This Week: 0</div>
        <div id="count-month">This Month: 0</div>
    </div>

    <div id="results"></div>

    <script>
        async function searchPubMed() {
            const query = document.getElementById("query").value;
            if (!query) return;

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, "0");
            const dd = String(today.getDate()).padStart(2, "0");

            const todayStr = `${yyyy}/${mm}/${dd}`;
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            const weekStr = `${weekAgo.getFullYear()}/${String(weekAgo.getMonth() + 1).padStart(2, "0")}/${String(weekAgo.getDate()).padStart(2, "0")}`;
            const monthAgo = new Date(today);
            monthAgo.setDate(today.getDate() - 30);
            const monthStr = `${monthAgo.getFullYear()}/${String(monthAgo.getMonth() + 1).padStart(2, "0")}/${String(monthAgo.getDate()).padStart(2, "0")}`;

            // counts
            updateCounts(query, todayStr, todayStr, "count-day");
            updateCounts(query, weekStr, todayStr, "count-week");
            updateCounts(query, monthStr, todayStr, "count-month");

            // main search (last 100)
            const esearchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&retmode=json&retmax=30&sort=date`;
            const esearchResp = await fetch(esearchUrl);
            const esearchData = await esearchResp.json();
            const ids = esearchData.esearchresult.idlist;

            if (ids.length === 0) {
                document.getElementById("results").innerHTML = "<p>No results found.</p>";
                return;
            }

            const efetchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${ids.join(",")}&retmode=xml`;
            const efetchResp = await fetch(efetchUrl);
            const xmlText = await efetchResp.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");

            renderResults(xmlDoc);
        }

        async function updateCounts(query, fromDate, toDate, elementId) {
            const url = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(query)}&mindate=${fromDate}&maxdate=${toDate}&datetype=pdat&retmode=json`;
            const resp = await fetch(url);
            const data = await resp.json();
            document.getElementById(elementId).innerText = `${document.getElementById(elementId).innerText.split(":")[0]}: ${data.esearchresult.count}`;
        }

        function renderResults(xmlDoc) {
            const articles = xmlDoc.getElementsByTagName("PubmedArticle");
            let html = "";
            for (let i = 0; i < articles.length; i++) {
                const article = articles[i];
                const title = article.getElementsByTagName("ArticleTitle")[0]?.textContent || "No title";
                const abstract = article.getElementsByTagName("AbstractText")[0]?.textContent || "No abstract available.";

                const authorNodes = article.getElementsByTagName("Author");
                let authors = [];
                for (let j = 0; j < authorNodes.length; j++) {
                    const lastName = authorNodes[j].getElementsByTagName("LastName")[0]?.textContent || "";
                    const foreName = authorNodes[j].getElementsByTagName("ForeName")[0]?.textContent || "";
                    const affiliation = authorNodes[j].getElementsByTagName("Affiliation")[0]?.textContent || "";
                    let name = `${foreName} ${lastName}`;
                    if (affiliation.includes("Rochester") && affiliation.includes("Minnesota")) {
                        name = `<span class="underline">${name}</span>`;
                    }
                    authors.push(name);
                }

                html += `
                    <div class="card">
                        <div class="title">${title}</div>
                        <div class="authors">${authors.join(", ")}</div>
                        <div class="abstract">${abstract}</div>
                    </div>
                `;
            }
            document.getElementById("results").innerHTML = html;
        }
    </script>
</body>
</html>
