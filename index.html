<!-- One -->
<section id="one" class="wrapper style1 special">
  <div class="inner">
    <header class="major">
      <h2>Recently Published in Rochester, MN:</h2>
    </header>

    <!-- Numbers Section -->
    <div style="display: flex; justify-content: space-around; text-align: center; margin-top: 2em;">
      <div class="stat-item">
        <h2 id="VarDay">0</h2>
        <p>new today</p>
      </div>
      <div class="stat-item">
        <h2 id="VarWeek">0</h2>
        <p>new this week</p>
      </div>
      <div class="stat-item">
        <h2 id="VarMonth">0</h2>
        <p>new this month</p>
      </div>
    </div>
  </div>

  <!-- Dropdown + Results Container -->
  <div class="pubmed-container">
    <select id="pubmed-query" onchange="fetchPubMedResults()">
      <option value="everything" selected>Everything</option>
      <option value="genai">Generative AI</option>
      <option value="deeplearning">Deep Learning</option>
      <option value="informatics">Informatics</option>
      <option value="radiology">Radiology</option>
    </select>

    <!-- Results Grid -->
    <div id="pubmed-results" class="results-grid"></div>
  </div>

  <style>
    .pubmed-container {
      margin: 0 auto;
      padding: 0 20px;
      max-width: 1200px;
    }
    .pubmed-container select {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .result-item {
      background: #fff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: left;
      transition: transform 0.2s;
    }
    .result-item:hover {
      transform: translateY(-5px);
    }
    .result-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #2c3e50;
      text-decoration: none;
    }
    .result-title:hover {
      text-decoration: underline;
    }
    .result-authors {
      font-size: 0.9em;
      margin: 8px 0;
    }
    .result-citation {
      font-size: 0.8em;
      color: #666;
    }
    .share-buttons {
      margin-top: 8px;
    }
    .share-buttons a {
      margin-right: 8px;
      font-size: 0.8em;
      color: #0066cc;
      text-decoration: none;
    }
    .share-buttons a:hover {
      text-decoration: underline;
    }
  </style>

  <script>
    async function fetchPubMedResults() {
      const queryType = document.getElementById("pubmed-query").value;
      const queries = {
        everything: `("Mayo"[AD] AND ("Minnesota"[AD] OR "MN"[AD]))`,
        genai: `(("Generative AI" OR "Large language model" OR "chatgpt") AND "Mayo"[AD] AND ("Minnesota"[AD] OR "MN"[AD]))`,
        deeplearning: `(("Deep learning" OR "Neural network") AND "Mayo"[AD] AND ("Minnesota"[AD] OR "MN"[AD]))`,
        informatics: `("informatics" AND "Mayo"[AD] AND ("Minnesota"[AD] OR "MN"[AD]))`,
        radiology: `(("CT" OR "MRI" OR "ultrasound" OR "radiology") AND "Mayo"[AD] AND ("Minnesota"[AD] OR "MN"[AD]))`
      };

      const term = queries[queryType];
      const esearchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(term)}&retmax=12&sort=pub+date`;

      try {
        const esearchRes = await fetch(esearchUrl);
        const esearchText = await esearchRes.text();
        const parser = new DOMParser();
        const esearchXml = parser.parseFromString(esearchText, "text/xml");
        const ids = Array.from(esearchXml.querySelectorAll("Id")).map(node => node.textContent);

        if (ids.length === 0) {
          document.getElementById("pubmed-results").innerHTML = "<p>No results found.</p>";
          return;
        }

        const efetchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${ids.join(",")}&retmode=xml`;
        const efetchRes = await fetch(efetchUrl);
        const efetchText = await efetchRes.text();
        const efetchXml = parser.parseFromString(efetchText, "text/xml");

        const resultsDiv = document.getElementById("pubmed-results");
        resultsDiv.innerHTML = "";

        const articles = efetchXml.querySelectorAll("PubmedArticle");
        articles.forEach(article => {
          const pmid = article.querySelector("PMID")?.textContent || "";
          const title = article.querySelector("ArticleTitle")?.textContent || "No title";
          const journal = article.querySelector("Journal > Title")?.textContent || "";
          const pubdate = article.querySelector("PubDate Year")?.textContent || "";

          let authors = [];
          article.querySelectorAll("Author").forEach(authorNode => {
            const lastName = authorNode.querySelector("LastName")?.textContent || "";
            const foreName = authorNode.querySelector("ForeName")?.textContent || "";
            const name = `${foreName} ${lastName}`.trim();

            let affiliations = [];
            authorNode.querySelectorAll("Affiliation").forEach(aff => {
              affiliations.push(aff.textContent);
            });

            let displayName = name;
            if (affiliations.some(a => /Rochester/i.test(a))) {
              displayName = `<u>${displayName}</u>`;
            }
            if (name) authors.push(displayName);
          });

          const authorsHtml = authors.join(", ");
          const citation = `${journal}. ${pubdate}. PMID: ${pmid}`;
          const url = `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`;

          const item = document.createElement("div");
          item.className = "result-item";
          item.innerHTML = `
            <a href="${url}" target="_blank" class="result-title">${title}</a>
            <div class="result-authors">${authorsHtml}</div>
            <div class="result-citation"><em>${citation}</em></div>
            <div class="share-buttons">
              <a class="twitter" href="https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}" target="_blank">Twitter</a>
              <a class="linkedin" href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}" target="_blank">LinkedIn</a>
              <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" target="_blank">Facebook</a>
            </div>
          `;
          resultsDiv.appendChild(item);
        });
      } catch (error) {
        console.error(error);
        document.getElementById("pubmed-results").innerHTML = "<p>Error fetching results.</p>";
      }
    }

    document.addEventListener("DOMContentLoaded", fetchPubMedResults);
  </script>
</section>
